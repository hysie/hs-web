{"version":3,"sources":["../../engine/lib/parser.js","../../engine/lib/parser-utils.js","../../engine/lib/functions.js","../../engine/lib/environment.js","../../engine/lib/slimdown.js","../../engine/lib/gameobject.js","../../engine/lib/components/passageComponent.js","../../engine/lib/components/menuComponent.js","utils.js","emitter.js","store.js","hooks.js","editor/dataio.js","editor/textEditor.js","components/errorBoundary.js","editor/textEditorManager.js","components/tabs.js","components/globalHotKeys.js","components/mainMenu.js","components/aboutDialog.js","components/preferences.js","components/newProject.js","components/webDialogs.js","components/titleBar.js","components/preview.js","App.js","serviceWorker.js","index.js","../../engine/lib/engine.js","../../engine/lib/AST.js","../../engine/lib/utils.js"],"names":["P","require","util","AST","lodash","YAML","HyperSigil","createLanguage","Name","r","regexp","node","Number","Index","seq","string","within","Text","Block","all","CallSymbol","CallName","alt","then","many","Call","optWhitespace","String","takeWhile","c","assert","s","length","SetExpression","Operator","Operand","trim","Expression","Parser","this","parseText","memoize","text","parse","parseCallName","parseExpression","raw","parser","status","SyntaxError","index","expected","value","expand","ast","traverse","path","token","name","inner","tokenize","start","offset","line","column","end","replace","flatten","e","console","log","JSON","stringify","file","relaxYaml","baseKey","normalizePath","match","slice","chunk","split","map","passage","yaml","undefined","Error","front","module","exports","indexHashTable","Map","getIndex","input","clear","has","set","lines","Array","columns","i","crlf","cr","lf","mem","get","begin","j","charAt","substr","result","makeSuccess","makeFailure","stripTrailing","TypeError","len","prefix","ch","segs","pop","join","normalizePathX","endsWith","startsWith","encodeUnicode","str","btoa","encodeURIComponent","p1","fromCharCode","decodeUnicode","decodeURIComponent","atob","charCodeAt","toString","trimByBackslash","left","trimLeft","right","trimRight","triple","cleft","cright","escape","unescape","ev","document","engine","evaluate","clean","trimIndeent","tabspaces","search","tabindex","comment","new","className","args","env","if","condition","action","otherwise","accepted","Lang","evalConditional","function","local","push","Standard","true","false","hide","goto","dest","currentPassageName","goToPassage","refresh","math","expression","evalMath","js","eval","include","pass","passages","resolvePassageName","html","rand","Math","random","round","parseFloat","Random","choice","floor","json","array","alert","exists","Components","link","encoded","encode","replace_link","id","addCallback","getElementById","innerHTML","exhaust_menu","final","some","item","seenPath","tlist","img","title","list","textbox","placeholder","elm","dialog","nametag","error","Documentation","external_link","url","codespan","code","continue","decode","toDot","evaluateNode","op","operationMap","a","b","null","every","operations","reduce","createStore","produce","undoable","default","ActionCreators","excludeAction","VariableNotFoundError","ReferenceError","Scope","init","_internal","def","LocalScope","state","GlobalScope","baseReducer","type","draft","mergeWith","objValue","srcValue","__serial__","__attr__","toJSON","game","reducer","limit","ignoreInitialState","filter","_cache","window","__REDUX_DEVTOOLS_EXTENSION__","_classes","getState","present","range","indexOf","obj","dispatch","clearHistory","self","cloneDeepWith","instance","fromJSON","bind","StaticScope","Object","freeze","Environment","_env","global","static","passageName","forceflush","flush","undo","redo","theClass","prototype","rules","_","h","level","__","render","markdown","forEach","regex","subst","GameObject","keys","it","TheClass","PassageComponent","body","element","createElement","appendChild","props","last","classList","toggle","setTimeout","replaceChild","MenuComponent","active","wrap","setAttribute","menu","items","createButton","nav","createMenu","canUndo","canRedo","uuidv4","getBasename","hotkeyString","hotkey","navigator","platform","toUpperCase","sequence","emitter","Emitter","toaster","Toaster","create","isElectron","userAgent","toLowerCase","sendMessage","content","from","api","send","uuid","receive","session","texts","tabs","passive","findIndex","tab","key","emit","show","message","intent","Intent","DANGER","version","on","modified","command","preferences","commands","run","build","factor","addEventListener","event","ctrlKey","altKey","WARNING","icon","clearPreferences","clearSession","Store","initialState","localStorageKey","_state","_reducer","localStorage","getItem","setItem","blanktab","dirty","sessionInitialState","app","preferencesInitialState","editor","fontFamily","fontSize","zoom","saveSession","merge","copyback","mod","useEvent","func","deps","useEffect","off","useSelector","store","selector","useState","setValue","newvalue","useWindowSize","width","innerWidth","height","innerHeight","windowSize","setWindowSize","handleResize","removeEventListener","useDecorator","useCallback","isText","Node","children","ranges","expressionNames","tokens","tkl","re","exec","withSmallMarks","isExpression","includes","isAdjacent","focus","anchor","TextEditor","initialText","pref","useMemo","Editor","normalizeNode","insertPassage","selection","descendant","attrs","at","mode","Transforms","insertNodes","tabSpaces","select","collapse","edge","removePassage","removeNodes","entry","Element","isElement","mergeNodes","delete","setNodes","withPassages","withHistory","withReact","createEditor","renderLeaf","Leaf","keyDownHandler","metaKey","ignoreKeys","keyCode","preventDefault","insertText","getPrefix","distance","reverse","move","unit","useKeyDownHandler","decorate","reply","deserialize","renderElement","attributes","contentEditable","style","userSelect","onChange","spellcheck","tabIndex","autoFocus","onKeyDown","onSelect","chrome","ReactEditor","toDOMPoint","parentElement","scrollIntoView","behavior","block","leaf","spellCheck","num","repeat","before","lastIndexOf","ErrorBoundary","hasError","errorInfo","errora","React","Component","TextEditorManager","windowHeight","parseFile","fakefront","iconName","Tab","dataKey","minimal","onClick","fill","alignText","Alignment","LEFT","maxWidth","minWidth","rightIcon","color","Tabs","windowWidth","interactionKind","PopoverInteractionKind","HOVER","position","Position","BOTTOM","padding","target","Classes","MINIMAL","BUTTON","min","GlobalHotKeys","keyMap","handlers","Mousetrap","unbind","stopCallback","combo","NEW_DOCUMENT","OPEN_DOCUMENT","SAVE_DOCUMENT","SAVE_DOCUMENT_AS","EXIT_APP","MainMenu","newDocument","openDocument","saveDocument","saveDocumentAs","BOTTOM_LEFT","Item","label","disabled","Divider","small","AboutDialog","isOpen","setState","DARK","onClose","DIALOG_BODY","RUNNING_TEXT","Title","margin","Preferences","prefs","setPref","size","labelFor","vertical","currentTarget","max","minorStepSize","onValueChange","x","inline","contentClassName","checked","NewProjectDialog","setName","setPath","handleClose","xpath","labelInfo","helperText","hasSelection","inputProps","DIALOG_FOOTER","DIALOG_FOOTER_ACTIONS","NONE","PRIMARY","RenameDialog","setIsOpen","handleDone","inputRef","onkeydown","TitleBar","overflow","Group","align","PreviewMenu","Button","Menu","restart","PreviewComponent","setText","files","Engine","initialPassage","autoSave","onPassageEnter","f","dangerouslySetInnerHTML","__html","getElementsByTagName","lang","App","display","Boolean","location","hostname","ReactDOM","StrictMode","serviceWorker","ready","registration","unregister","catch","functions","slimdown","renderFunction","hyperSigilFiles","options","_currentPassageHTML","_isPassageLoading","_evaluationDepth","DOMCallbacks","onPassageDone","onPassageLeave","entries","currentGame","load","initialPassageName","root","getChildByName","output","err","tree","names","concat","ref","CallList","Operation","operator","operand","OperationList","nodeA","nodeB","parserfunc","passageIsLoading","_DOMCallbacks","next","currentPassageHTML","removeItem","suffix","past","future","rawTree","isValid","validate","enter","leave","dfs","isLeaf","arr","getNodesByName","child","find","copy","subtree","old","cloneDeep","hashFromPath","ids","isArray","isIndex","rootdif","isNode","parserUtils","object","properties","Set","Reflect","ownKeys","add","getPrototypeOf","getAllProperties","constructor","descriptor","getOwnPropertyDescriptor"],"mappings":"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","file":"static/js/main.d7f3c526.chunk.js","sourcesContent":["const P = require('parsimmon')\r\nconst util = require('./parser-utils.js')\r\nconst AST = require('./AST')\r\nconst lodash = require('lodash')\r\nconst YAML = require('yaml')\r\n\r\nvar HyperSigil = P.createLanguage({\r\n  Name: function (r) {\r\n    return P.regexp(/([A-Za-z_][A-Za-z0-9_]*)/).node('Name')\r\n  },\r\n  Number: function (r) {\r\n    return P.regexp(/[+-]?([0-9]*[.])?[0-9]+/).node('Number')\r\n  },\r\n  Index: function (r) {\r\n    return P.seq(\r\n      P.string('[').node('IO'),\r\n      util.within('[', r.Text, ']'),\r\n      P.string(']').node('IC')\r\n    ).node('Index')\r\n  },\r\n  Block: function (r) {\r\n    return P.seq(\r\n      P.string('{').node('BO'),\r\n      util.within('{', P.all.node('All'), '}'),\r\n      P.string('}').node('BC')\r\n    ).node('Block')\r\n  },\r\n  CallSymbol: function (r) {\r\n    return P.string('$').node('CallSymbol')\r\n  },\r\n  CallName: function (r) {\r\n    return P.seq(\r\n      r.Name,\r\n      P.alt(P.string('.').then(r.Name), r.Index).many().node('SubnameList')\r\n    ).node('CallName')\r\n  },\r\n  Call: function (r) {\r\n    return P.seq(\r\n      r.CallSymbol,\r\n      r.CallName,\r\n      P.optWhitespace.then(r.Block).many().node('CallList')\r\n    ).node('Call')\r\n  },\r\n  String: function (r) {\r\n    return P.alt(\r\n      P.takeWhile(c => c !== '$').assert(s => s.length > 0),\r\n      P.string('$'),\r\n      P.all.assert(s => s.length > 0)\r\n    ).node('String')\r\n  },\r\n  Text: function (r) {\r\n    return P.alt(r.SetExpression, r.Call, r.String).many().node('Text')\r\n  },\r\n  Operator: function (r) {\r\n    return P.alt(\r\n      P.string('&&'), P.string('||'), P.string('!!'), P.string('AND'), P.string('OR'), P.string('XOR'),\r\n      P.string('>>'), P.string('<<'), P.string('<-'), P.string('->'),\r\n      P.string('+='), P.string('-='), P.string('*='), P.string('/='),\r\n      P.string('=='), P.string('>='), P.string('<='), P.string('!='), P.string('>'), P.string('<'),\r\n      P.string('='), P.string('+'), P.string('-'), P.string('*'), P.string('/'), P.string('^')\r\n    ).node('Operator')\r\n  },\r\n  Operand: function (r) {\r\n    return P.alt(r.Call, r.Number, r.Block).trim(P.optWhitespace).node('Operand')\r\n  },\r\n  Expression: function (r) {\r\n    return P.seq(\r\n      r.Operand,\r\n      P.seq(r.Operator, r.Operand).node('Operation').many().node('OperationList')\r\n    ).node('Expression')\r\n  },\r\n  SetExpression: function (r) {\r\n    return P.seq(\r\n      r.CallSymbol,\r\n      r.CallName,\r\n      P.alt(\r\n        P.string('='),\r\n        P.string('+='),\r\n        P.string('-=')\r\n      ).trim(P.optWhitespace).node('SetOperator'),\r\n      r.Operand\r\n    ).node('SetExpression')\r\n  }\r\n})\r\n\r\nclass Parser {\r\n  constructor () {\r\n    this.parseText = lodash.memoize((text) => HyperSigil.Text.parse(text))\r\n    this.parseCallName = lodash.memoize((text) => HyperSigil.CallName.parse(text))\r\n    this.parseExpression = lodash.memoize((text) => HyperSigil.Expression.parse(text))\r\n  }\r\n\r\n  parse (text, parser = HyperSigil.Text) {\r\n    let raw\r\n    if (parser === HyperSigil.Text) raw = this.parseText(text)\r\n    else if (parser === HyperSigil.CallName) raw = this.parseCallName(text)\r\n    else if (parser === HyperSigil.Expression) raw = this.parseExpression(text)\r\n    else raw = parser.parse(text)\r\n\r\n    if (raw.status === false) throw SyntaxError(`on ${raw.index}, expected ${raw.expected}`)\r\n    return new AST(raw.value)\r\n  }\r\n\r\n  tokenize (text, expand = false) {\r\n    try {\r\n      const ast = this.parse(text)\r\n      if (expand) {\r\n        ast.traverse((path, token) => {\r\n          if (token.name === 'All') {\r\n            const inner = {\r\n              name: 'AllX',\r\n              value: this.tokenize(token.value, true),\r\n              start: {\r\n                offset: 0,\r\n                line: 1,\r\n                column: 1\r\n              },\r\n              end: {\r\n                offset: token.end.offset - token.start.offset,\r\n                line: token.end.line - token.start.line + 1,\r\n                column: token.end.column - token.start.column + 1\r\n              }\r\n            }\r\n            ast.replace(path, inner)\r\n          }\r\n        })\r\n      }\r\n      return ast.flatten()\r\n    } catch (e) {\r\n      console.log(JSON.stringify(text))\r\n      throw e\r\n    }\r\n  }\r\n\r\n  parseFile (path, file, relaxYaml = false) {\r\n    const baseKey = util.normalizePath(path)\r\n    file = file.replace(/(?:\\r\\n|\\r|\\n)/g, '\\n')\r\n\r\n    // Divide passages by front matter if any\r\n    const match = file.match(/^[--]-+\\n/g)\r\n    if (!match) {\r\n      file = '---\\npassage:\\n    name: default\\n    fakefront: true\\n---\\n' + file\r\n    }\r\n\r\n    file = file.slice(match ? match[0].length : 3)\r\n    return lodash.chunk(file.split(/[--]-+\\n/g), 2).map(passage => {\r\n      let yaml = YAML.parse(passage[0])\r\n      if (!yaml || yaml.passage === undefined) {\r\n        if (!relaxYaml) throw new Error(`Yaml failed to parse on ${passage[0]}`)\r\n        else yaml = { passage: { name: '' } }\r\n      }\r\n      const name = baseKey + '.' + yaml.passage.name\r\n      return {\r\n        name: name,\r\n        front: passage[0],\r\n        text: passage[1],\r\n        yaml: yaml\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nmodule.exports = { HyperSigil, Parser }\r\n","const P = require('parsimmon')\r\nconst AST = require('./AST')\r\nconst lodash = require('lodash')\r\n\r\nconst indexHashTable = new Map()\r\n/**\r\n * Return a token with no data at an offset position from the input.\r\n * Useful for getting line number and column. O(n)\r\n * @param  {string} input  Input string\r\n * @param  {integer} offset Position starting from 0.\r\n * @return {Token} Token object\r\n */\r\nfunction getIndex (input, offset) {\r\n  if (indexHashTable.length > 128) indexHashTable.clear()\r\n\r\n  function memoize (input) {\r\n    const lines = new Array(input.length)\r\n    const columns = new Array(input.length)\r\n\r\n    let line = 1\r\n    let column = 1\r\n    for (let i = 0; i <= input.length; i++) {\r\n      lines[i] = line\r\n      columns[i] = column\r\n\r\n      const crlf = (i > 0 && input[i - 1] === '\\r' && input[i] === '\\n')\r\n      const cr = (input[i] === '\\r')\r\n      const lf = (input[i] === '\\n')\r\n      if ((cr || lf) && !crlf) {\r\n        line++\r\n        column = 0\r\n      }\r\n      column++\r\n    }\r\n    return [lines, columns]\r\n  }\r\n  if (!indexHashTable.has(input)) indexHashTable.set(input, memoize(input))\r\n  const mem = indexHashTable.get(input)\r\n  return { offset: offset, line: mem[0][offset], column: mem[1][offset] }\r\n}\r\n\r\n/**\r\n * Parser that consumes everything within a well parentesiszed expression\r\n * Assumes begin already matched, doesn't consume end. O(n) of whole input.\r\n * @param  {integer} begin  [description]\r\n * @param  {parser} parser [description]\r\n * @param  {integer} end    [description]\r\n * @return {parser}        [description]\r\n */\r\nfunction within (begin, parser, end) {\r\n  return P(function (input, i) {\r\n    let c = 1\r\n    for (let j = i; j < input.length; j++) {\r\n      if (input.charAt(j) === begin) c++\r\n      if (input.charAt(j) === end) c--\r\n      if (c <= 0) {\r\n        const text = input.substr(i, (j - i))\r\n        const result = parser.parse(text)\r\n        new AST(result.value).offset = getIndex(input, i)\r\n        if (result.status) return P.makeSuccess(j, result.value)\r\n        else return P.makeFailure(i, result.value)\r\n      }\r\n    }\r\n    return P.makeFailure(i, 'is not well paranthesized!')\r\n  })\r\n}\r\n\r\nfunction normalizePath (path) {\r\n  /*!\r\n   * unixify <https://github.com/jonschlinkert/unixify>\r\n   * normalize-path <https://github.com/jonschlinkert/normalize-path>\r\n   *\r\n   * Copyright (c) 2014-2018, Jon Schlinkert.\r\n   * Released under the MIT License.\r\n   */\r\n  function unixify (filepath, stripTrailing) {\r\n    function normalizePathX (path, stripTrailing) {\r\n      if (typeof path !== 'string') {\r\n        throw new TypeError('expected path to be a string')\r\n      }\r\n\r\n      if (path === '\\\\' || path === '/') return '/'\r\n\r\n      var len = path.length\r\n      if (len <= 1) return path\r\n\r\n      // ensure that win32 namespaces has two leading slashes, so that the path is\r\n      // handled properly by the win32 version of path.parse() after being normalized\r\n      // https://msdn.microsoft.com/library/windows/desktop/aa365247(v=vs.85).aspx#namespaces\r\n      var prefix = ''\r\n      if (len > 4 && path[3] === '\\\\') {\r\n        var ch = path[2]\r\n        if ((ch === '?' || ch === '.') && path.slice(0, 2) === '\\\\\\\\') {\r\n          path = path.slice(2)\r\n          prefix = '//'\r\n        }\r\n      }\r\n\r\n      var segs = path.split(/[/\\\\]+/)\r\n      if (stripTrailing !== false && segs[segs.length - 1] === '') {\r\n        segs.pop()\r\n      }\r\n      return prefix + segs.join('/')\r\n    }\r\n\r\n    filepath = normalizePathX(filepath, stripTrailing)\r\n    return filepath.replace(/^([a-zA-Z]+:|\\.\\/)/, '')\r\n  }\r\n\r\n  path = unixify(path)\r\n  if (path.endsWith('.utf8')) path = path.slice(0, -5)\r\n  if (path.endsWith('.txt')) path = path.slice(0, -4)\r\n  if (path.startsWith('.')) path = path.slice(1)\r\n  if (path.startsWith('/')) path = path.slice(1)\r\n  return path.replace('/', '.')\r\n}\r\n\r\nfunction encodeUnicode (str) {\r\n  /* global btoa */\r\n  // first we use encodeURIComponent to get percent-encoded UTF-8,\r\n  // then we convert the percent encodings into raw bytes which\r\n  // can be fed into btoa.\r\n  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,\r\n    function toSolidBytes (match, p1) {\r\n      return String.fromCharCode('0x' + p1)\r\n    }))\r\n}\r\n\r\nfunction decodeUnicode (str) {\r\n  /* global atob */\r\n  // Going backwards: from bytestream, to percent-encoding, to original string.\r\n  return decodeURIComponent(atob(str).split('').map(function (c) {\r\n    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)\r\n  }).join(''))\r\n}\r\n\r\n/**\r\n * This function implements the backslash operator as defined by SugarCube.\r\n * The function is ideended to be a middleware used after evaluating Text nodes.\r\n * This function is not very efficient. Use with care.\r\n */\r\nfunction trimByBackslash (text) {\r\n  // Normalize line-breaks\r\n  text = text.replace(/(?:\\r\\n|\\r|\\n)/g, '\\n')\r\n\r\n  // Trim spaces left and right of every line if adjacent to operator.\r\n  const lines = text.split('\\n').map(line => {\r\n    const left = line.trimLeft()\r\n    if (left.startsWith('\\\\') && !left.startsWith('\\\\\\\\\\\\')) line = left\r\n    const right = line.trimRight()\r\n    if (right.endsWith('\\\\') && !right.endsWith('\\\\\\\\\\\\')) line = right\r\n    return line\r\n  })\r\n\r\n  // Notice last line of file ends in EOF and not a new line, so we automatically\r\n  // add the operator to avoid inserting it.\r\n  lines[lines.length - 1] += '\\\\'\r\n\r\n  // For every line check if it should keep or remove the new line character.\r\n  // Also remove the backslash operators themseleves. Final text should be clear of any.\r\n  let result = ''\r\n  for (const line of lines) {\r\n    const triple = line.startsWith('\\\\\\\\\\\\') || line.endsWith('\\\\\\\\\\\\')\r\n    const cleft = line.startsWith('\\\\') && result.endsWith('\\n') && !triple\r\n    const cright = line.endsWith('\\\\') && !triple\r\n    if (line === '\\\\') {\r\n      // Nothing\r\n    } else if (cleft && cright) {\r\n      result = result.slice(0, -1) + line.slice(1, -1).replace('\\\\', '')\r\n    } else if (cleft) {\r\n      result = result.slice(0, -1) + line.slice(1).replace('\\\\', '') + '\\n'\r\n    } else if (cright) {\r\n      result += line.slice(0, -1).replace('\\\\', '')\r\n    } else {\r\n      result += line.replace('\\\\', '') + '\\n'\r\n    }\r\n  }\r\n  return result.replace('\\\\\\\\\\\\', '\\\\')\r\n}\r\n\r\nfunction escape (text) {\r\n  return lodash.escape(text)\r\n    .replace(/#/g, '&num;')\r\n    .replace(/\\*/g, '&ast;')\r\n    .replace(/\\\\/g, '&bsol;')\r\n    .replace(/~/g, '&tilde;')\r\n}\r\n\r\nfunction unescape (text) {\r\n  return lodash.unescape(text)\r\n    .replace(/&num;/g, '#')\r\n    .replace(/&ast;/g, '*')\r\n    .replace(/&bsol;/g, '\\\\')\r\n    .replace(/&tilde;/g, '~')\r\n}\r\n\r\nmodule.exports = { getIndex, within, normalizePath, encodeUnicode, decodeUnicode, trimByBackslash, escape, unescape }\r\n","const util = require('./utils')\r\nconst lodash = require('lodash')\r\nconst { HyperSigil } = require('./parser')\r\n\r\nfunction ev (text) {\r\n  return document.engine.evaluate(text)\r\n}\r\n\r\nfunction clean (text) {\r\n  return text.replace(/(?:\\r\\n|\\r|\\n)/g, '').trim()\r\n}\r\n\r\nfunction trimIndeent (text) {\r\n  const lines = text.split('\\n')\r\n  if (lines.length === 0) return text\r\n  const tabspaces = lines[0].search(/\\S/)\r\n  if (tabspaces === -1) return trimIndeent(lines.slice(1).join('\\n'))\r\n  return lines.map(line => {\r\n    const tabindex = line.search(/\\S/)\r\n    if (tabspaces <= tabindex) return line.slice(tabspaces)\r\n    else return line.trimLeft()\r\n  }).join('\\n')\r\n}\r\n\r\nmodule.exports = {\r\n  raw: function (text) {\r\n    return util.escape(text.replace('\\\\', '\\\\\\\\\\\\'))\r\n  },\r\n  comment: function (text) {\r\n    // Do nothing\r\n  },\r\n  new: function (className, ...args) {\r\n    return document.engine.env.new(className, ...args)\r\n  },\r\n  if: function (condition, action, otherwise = '') {\r\n    if (condition === undefined || action === undefined) throw new Error('If requieres a conition and action')\r\n    if (condition === '') return ev(action)\r\n    const accepted = module.exports.HyperSigil.Lang.evalConditional(condition)\r\n    if (accepted) return ev(action)\r\n    else return ev(otherwise)\r\n  },\r\n  function: function (text) {\r\n    return (...args) => {\r\n      document.engine.env.local.push({ args: args })\r\n      let result = text\r\n      for (let i = 1; i <= args.length; i++) {\r\n        result = result.replace('$' + i, args[i - 1])\r\n      }\r\n      result = ev(result)\r\n      document.engine.env.local.pop()\r\n      return result\r\n    }\r\n  },\r\n  HyperSigil: {\r\n    Standard: {\r\n      true: true,\r\n      false: false,\r\n      hide: function (text) {\r\n        ev(text)\r\n      },\r\n      goto: function (dest) {\r\n        if (dest === undefined || dest === '') dest = document.engine.currentPassageName\r\n        document.engine.goToPassage(dest.trim())\r\n      },\r\n      refresh: function () {\r\n        document.engine.goToPassage('.')\r\n      },\r\n      math: function (expression) {\r\n        return module.exports.HyperSigil.Lang.evalMath(expression)\r\n      },\r\n      js: function (text) {\r\n        // eslint-disable-next-line no-eval\r\n        return eval(text)\r\n      },\r\n      include: function (text) {\r\n        document.engine.env.local.push()\r\n        const pass = ev(document.engine.passages[document.engine.resolvePassageName(text)].text)\r\n        document.engine.env.local.pop()\r\n        return pass\r\n      },\r\n      eval: function (text) {\r\n        return lodash.unescape(ev(ev(text)))\r\n      },\r\n      html: function (text) {\r\n        return lodash.unescape(ev(text))\r\n      },\r\n      rand: function (...args) {\r\n        args = args.map(e => ev(e))\r\n        if (args.length === 0) return Math.random()\r\n        if (args.length === 1) return Math.round(Math.random() * parseFloat(args[0]))\r\n        if (args.length === 2) return Math.round(Math.random() * (parseFloat(args[1]) - parseFloat(args[0])) + parseFloat(args[0]))\r\n      },\r\n      Random: {\r\n        choice: function (...args) {\r\n          return args.map(e => ev(e))[Math.floor(Math.random() * args.length)]\r\n        }\r\n      },\r\n      json: function (text) {\r\n        return JSON.parse(ev(text))\r\n      },\r\n      array: function (...args) {\r\n        return args.map(e => ev(e))\r\n      },\r\n      alert: function (text) {\r\n        /* global alert */\r\n        alert(ev(text))\r\n      },\r\n      exists: function (text) {\r\n        return document.engine.env.has(text)\r\n      }\r\n    },\r\n    Components: {\r\n      link: function (dest, name, action = '') {\r\n        if (dest === undefined || dest === '') dest = document.engine.currentPassageName\r\n        dest = dest.trim()\r\n\r\n        const encoded = module.exports.HyperSigil.Lang.encode(action)\r\n        return `<a href=# onclick=\"{\\\r\n          document.engine.evaluate(\\\r\n            document.engine.env.static.getState().HyperSigil.Lang.decode('${encoded}')\\\r\n          );\\\r\n          document.engine.goToPassage('${dest}')\\\r\n        }\">${ev(name)}</a>`\r\n      },\r\n      replace_link: function (name, text) {\r\n        const id = document.engine.addCallback(() => {\r\n          const elm = document.getElementById(id)\r\n          elm.innerHTML = ev(text)\r\n        })\r\n        return `<span id=\"${id}\"><a href='#' onclick=\"document.engine.DOMCallbacks['${id}']()\">${ev(name)}</a></span>`\r\n      },\r\n      exhaust_menu: function (text, final = '') {\r\n        let some = false\r\n        document.engine.env.local.push({\r\n          item: function (dest, name) {\r\n            const passageName = document.engine.resolvePassageName(dest)\r\n            const seenPath = ['game', 'passages', passageName, 'seen']\r\n            const id = document.engine.addCallback(() => {\r\n              document.engine.env.set(seenPath, true)\r\n              document.engine.goToPassage(dest)\r\n            })\r\n            const seen = document.engine.env.has(seenPath) ? document.engine.env.get(seenPath) : false\r\n            if (seen) return ''\r\n            some = true\r\n            return `<a href=\"#\" onclick=\"{document.engine.DOMCallbacks['${id}']()}\">${ev(name)}</a>\\n`\r\n          }\r\n        })\r\n        const tlist = ev(clean(text))\r\n        document.engine.env.local.pop()\r\n        return `<div>${some ? tlist : ev(final)}</div>`\r\n      },\r\n      img: function (link, action) {\r\n        const encoded = module.exports.HyperSigil.Lang.encode(action)\r\n        return `<a href=# onclick=\"{\\\r\n          document.engine.evaluate(\\\r\n            document.engine.env.HyperSigil.Lang.decode('${encoded}')\\\r\n          );\\\r\n        }\"><img src=\"${link}\"></a>`\r\n      },\r\n      title: function (text) {\r\n        return `<h1>${text}</h1>`\r\n      },\r\n      list: function (text) {\r\n        document.engine.env.local.push({\r\n          item: function (text) {\r\n            return `<li>${ev(text)}</li>`\r\n          }\r\n        })\r\n        const tlist = ev(clean(text))\r\n        document.engine.env.local.pop()\r\n        return `<ul>${tlist}</ul>`\r\n      },\r\n      textbox: function (placeholder, action) {\r\n        const id = document.engine.addCallback((e) => {\r\n          const elm = document.getElementById(id)\r\n          ev(action.replace(/\\$1/g, elm.value))\r\n        })\r\n        return `<input type=\"text\" class=\"textbox\" id=\"${id}\"\\\r\n          value=\"${ev(placeholder)}\"\\\r\n          onchange=\"document.engine.DOMCallbacks['${id}']()\"\\\r\n        />`\r\n      },\r\n      dialog: function (name, text) {\r\n        const nametag = name !== '' ? `<span class='dialog name'>${ev(name)}</span>` : ''\r\n        return `${nametag}<div class='dialog'>${ev(text)}</div>\\\\`\r\n      },\r\n      error: function (text) {\r\n        return `<span style=\"\\\r\n          display:inline-block;\\\r\n          padding:1px;\\\r\n          color: #D8000C;\\\r\n          background-color: #FFD2D2;\\\r\n          border: 2px solid red;\\\r\n          border-radius: 3px;\\\r\n          font-size: small;\\\r\n        \">${text}</span>`\r\n      }\r\n    },\r\n    Documentation: {\r\n      external_link: function (url, text) {\r\n        return `<a href=\"${url}\" target=\"_blank\" style=\"color: black\">${text}</a>`\r\n      },\r\n      codespan: function (text) {\r\n        return `<span class=\"code\">${text}</span>`\r\n      },\r\n      code: function (text) {\r\n        return `<div class=\"code\">${trimIndeent(text)}</div>`\r\n      },\r\n      continue: function (dest) {\r\n        return `<div style=\"text-align:right;margin:50px\"><a href='#' onclick=\"{document.engine.goToPassage('${dest.trim()}')}\"> > Continue</a></div>`\r\n      }\r\n    },\r\n    Lang: {\r\n      encode: function (text) {\r\n        return util.encodeUnicode(text)\r\n      },\r\n      decode: function (text) {\r\n        return util.decodeUnicode(text)\r\n      },\r\n      ast: function (text) {\r\n        return document.engine.parser.parse(text).toDot()\r\n      },\r\n      evalConditional: function (condition) {\r\n        const ast = document.engine.parser.parse(condition, HyperSigil.Expression)\r\n        return document.engine.evaluateNode(ast).map(op => {\r\n          const operationMap = {\r\n            '==': (a, b) => a.toString() === b.toString(),\r\n            '!=': (a, b) => a.toString() !== b.toString(),\r\n            '>=': (a, b) => Number(a) >= Number(b),\r\n            '<=': (a, b) => Number(a) <= Number(b),\r\n            '>': (a, b) => Number(a) > Number(b),\r\n            '<': (a, b) => Number(a) < Number(b),\r\n            null: (a, b) => a\r\n          }\r\n\r\n          if (op.op in operationMap) return operationMap[op.op](op.a, op.b)\r\n          else throw SyntaxError(`Operation ${op.op} is not defined for conditional expression ${condition}`)\r\n        }).every(e => e === true)\r\n      },\r\n      evalMath: function (expression) {\r\n        const ast = document.engine.parser.parse(expression, HyperSigil.Expression)\r\n        const operations = document.engine.evaluateNode(ast)\r\n        return operations.reduce((a, op) => {\r\n          const operationMap = {\r\n            '+': (b) => Number(a) + Number(b),\r\n            '-': (b) => Number(a) - Number(b),\r\n            '*': (b) => Number(a) * Number(b),\r\n            '/': (b) => Number(a) / Number(b)\r\n          }\r\n\r\n          if (op.op in operationMap) return operationMap[op.op](op.b).toString()\r\n          else throw SyntaxError(`Operation ${op.op} is not defined for conditional expression ${expression}`)\r\n        }, operations[0].a)\r\n      }\r\n    }\r\n  }\r\n}\r\n","const { createStore } = require('redux')\r\nconst { produce } = require('immer')\r\nconst undoable = require('redux-undo').default\r\nconst { ActionCreators, excludeAction } = require('redux-undo')\r\nconst lodash = require('lodash')\r\nconst util = require('./utils')\r\n\r\nclass VariableNotFoundError extends ReferenceError {\r\n  constructor (path) {\r\n    super(`Variable ${path.join('.')} not found`)\r\n    this.name = 'VariableNotFoundError'\r\n  }\r\n}\r\n\r\nclass Scope {\r\n  constructor (init = {}) {\r\n    this._internal = init\r\n  }\r\n\r\n  get (path, def) {\r\n    const r = lodash.get(this._internal, path, def)\r\n    if (r === undefined) throw new VariableNotFoundError(path)\r\n    else return r\r\n  }\r\n\r\n  set (path, value) {\r\n    lodash.set(this._internal, path, value)\r\n  }\r\n\r\n  has (path) {\r\n    return lodash.has(this._internal, path)\r\n  }\r\n\r\n  clear () {\r\n    this._internal = {}\r\n  }\r\n\r\n  getState () {\r\n    return this._internal\r\n  }\r\n}\r\n\r\nclass LocalScope extends Scope {\r\n  constructor (init = {}) {\r\n    super([init])\r\n  }\r\n\r\n  get (path, def) {\r\n    for (let i = this._internal.length; i >= 0; i--) {\r\n      if (lodash.has(this._internal[i], path)) return lodash.get(this._internal[i], path, def)\r\n    }\r\n    throw new VariableNotFoundError(path)\r\n  }\r\n\r\n  set (path, value) {\r\n    for (let i = this._internal.length; i >= 0; i--) {\r\n      if (lodash.has(this._internal[i], path)) return lodash.set(this._internal[i], path, value)\r\n    }\r\n    lodash.set(this._internal[this._internal.length - 1], path, value)\r\n  }\r\n\r\n  has (path) {\r\n    for (let i = this._internal.length; i >= 0; i--) {\r\n      if (lodash.has(this._internal[i], path)) return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  push (state = {}) {\r\n    this._internal.push(state)\r\n  }\r\n\r\n  pop () {\r\n    return this._internal.pop()\r\n  }\r\n\r\n  clear () {\r\n    this._internal = [{}]\r\n  }\r\n}\r\n\r\nclass GlobalScope extends Scope {\r\n  constructor () {\r\n    super()\r\n\r\n    this.baseReducer = (state, action) => {\r\n      switch (action.type) {\r\n        case 'CLEAR': return {}\r\n        case 'FLUSH':\r\n          return produce(state, draft => {\r\n            lodash.mergeWith(draft, action.value, (objValue, srcValue) => {\r\n              if (srcValue.__serial__ !== undefined) {\r\n                return {\r\n                  __serial__: srcValue.__serial__,\r\n                  __attr__: srcValue.toJSON()\r\n                }\r\n              }\r\n            })\r\n          })\r\n        case 'LOAD': return { passage: {}, game: { passages: {} }, ...action.value }\r\n        case 'PASSAGE': return produce(state, draft => {\r\n          draft.game.passages[draft.passage.name] = draft.passage\r\n          draft.passage = draft.game.passages[action.value]\r\n        })\r\n        default: return {}\r\n      }\r\n    }\r\n\r\n    this.reducer = undoable(this.baseReducer, {\r\n      limit: 100,\r\n      ignoreInitialState: true,\r\n      filter: excludeAction(['FLUSH', 'LOAD'])\r\n    })\r\n\r\n    this._cache = {}\r\n    this._internal = createStore(this.reducer,\r\n      window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__())\r\n    this._classes = {}\r\n  }\r\n\r\n  get (path, def) {\r\n    if (lodash.has(this._cache, path)) {\r\n      return lodash.get(this._cache, path, def)\r\n    } else if (lodash.has(this._internal.getState().present, path)) {\r\n      return this.push(path)\r\n    } else {\r\n      // So, since global is serialized, we don't know its contents, thus\r\n      // we fail to enter the previous conditional if we find a serialized object.\r\n      // Here we find the longest working path prefix and check if the failure\r\n      // is caused by a serialized object. If that's the case we push to cache\r\n      // and continue from there.\r\n      const prefix = path.slice(0, lodash.range(1, path.length + 1)\r\n        .map(i => path.slice(0, i))\r\n        .map(e => lodash.has(this._internal.getState().present, e))\r\n        .indexOf(false))\r\n      const obj = lodash.get(this._internal.getState().present, prefix)\r\n      if (obj !== undefined && obj.__serial__ !== undefined) {\r\n        this.push(prefix)\r\n        if (lodash.has(this._cache, path)) {\r\n          return lodash.get(this._cache, path, def)\r\n        } else throw new VariableNotFoundError(path)\r\n      } else throw new VariableNotFoundError(path)\r\n    }\r\n  }\r\n\r\n  set (path, value) {\r\n    if (value === undefined) throw Error(`Setting ${path.join('.')} to undefined`)\r\n    lodash.set(this._cache, path, value)\r\n  }\r\n\r\n  has (path) {\r\n    return lodash.has(this._cache, path) || lodash.has(this._internal.getState().present, path)\r\n  }\r\n\r\n  clear () {\r\n    this._cache = {}\r\n    this._internal.dispatch({ type: 'CLEAR' })\r\n    this._internal.dispatch(ActionCreators.clearHistory())\r\n  }\r\n\r\n  flush () {\r\n    this._internal.dispatch({ type: 'FLUSH', value: this._cache })\r\n    this._cache = {}\r\n  }\r\n\r\n  push (path, value) {\r\n    const self = this\r\n    function serialize (value) {\r\n      if (typeof value === 'object' && value.__serial__ !== undefined && value.__attr__ !== undefined) {\r\n        const instance = self._classes[value.__serial__].fromJSON(value.__attr__)\r\n        if (instance.__serial__ === undefined) instance.__serial__ = value.__serial__\r\n        util.bind(instance)\r\n        return instance\r\n      }\r\n    }\r\n    if (value === undefined) {\r\n      value = lodash.get(this._internal.getState().present, path)\r\n    }\r\n    value = lodash.cloneDeepWith(value, serialize)\r\n    lodash.set(this._cache, path, value)\r\n    return value\r\n  }\r\n\r\n  dispatch (action) {\r\n    return this._internal.dispatch(action)\r\n  }\r\n\r\n  getState () {\r\n    return this._internal.getState().present\r\n  }\r\n}\r\n\r\nclass StaticScope extends Scope {\r\n  constructor (init) {\r\n    super(init)\r\n    this._internal = Object.freeze(this._internal)\r\n  }\r\n\r\n  set (path, value) {\r\n    throw new TypeError(`Variable ${path.join('.')} is static, can not be set`)\r\n  }\r\n\r\n  clear () {\r\n    // It's static, we don't clear. Also we don't fail, we just ignore.\r\n  }\r\n}\r\n\r\nclass Environment {\r\n  constructor (init) {\r\n    this._env = {\r\n      local: new LocalScope(),\r\n      global: new GlobalScope(),\r\n      static: new StaticScope(init)\r\n    }\r\n  }\r\n\r\n  get local () {\r\n    return this._env.local\r\n  }\r\n\r\n  get global () {\r\n    return this._env.global\r\n  }\r\n\r\n  get static () {\r\n    return this._env.static\r\n  }\r\n\r\n  has (path) {\r\n    const env = this._env\r\n    if (env.local.has(path)) return true\r\n    if (env.global.has(path)) return true\r\n    if (env.static.has(path)) return true\r\n    return false\r\n  }\r\n\r\n  get (path) {\r\n    const env = this._env\r\n    const prefix = [path[0]]\r\n    if (env.local.has(prefix)) return env.local.get(path)\r\n    if (env.global.has(prefix)) return env.global.get(path)\r\n    if (env.static.has(prefix)) return env.static.get(path)\r\n    throw new VariableNotFoundError(path)\r\n  }\r\n\r\n  set (path, value) {\r\n    const env = this._env\r\n    const prefix = [path[0]]\r\n    if (env.local.has(prefix)) env.local.set(path, value)\r\n    else if (env.global.has(prefix)) env.global.set(path, value)\r\n    else if (env.static.has(prefix)) env.static.set(path, value)\r\n    else env.local.set(path, value)\r\n  }\r\n\r\n  next (passageName, forceflush) {\r\n    const has = this._env.global.has(['passage', 'name'])\r\n    if ((has && this._env.global.get(['passage', 'name']) !== passageName) || forceflush) {\r\n      this._env.local.clear()\r\n      this._env.global.flush()\r\n      this._env.global.dispatch({ type: 'PASSAGE', value: passageName })\r\n    }\r\n  }\r\n\r\n  undo () {\r\n    this._env.local.clear()\r\n    this._env.global.flush()\r\n    this._env.global.dispatch(ActionCreators.undo())\r\n  }\r\n\r\n  redo () {\r\n    this._env.local.clear()\r\n    this._env.global.flush()\r\n    this._env.global.dispatch(ActionCreators.redo())\r\n  }\r\n\r\n  restart () {\r\n    this._env.local.clear()\r\n    this._env.global.clear()\r\n  }\r\n\r\n  load (state) {\r\n    this._env.local.clear()\r\n    this._env.global.clear()\r\n    this._env.global.dispatch({ type: 'LOAD', value: state })\r\n  }\r\n\r\n  register (theClass, className) {\r\n    if (className === undefined) className = theClass.name\r\n    if (!theClass.fromJSON || !theClass.prototype.toJSON) throw new Error(`Class ${className} is not serializable`)\r\n    this._env.global._classes[className] = theClass\r\n  }\r\n\r\n  new (className, ...args) {\r\n    const instance = new this._env.global._classes[className](...args)\r\n    if (instance.__serial__ === undefined) instance.__serial__ = className\r\n    util.bind(instance)\r\n    return instance\r\n  }\r\n}\r\n\r\nmodule.exports = Environment\r\n","/**\r\n * Slimdown - A very basic regex-based Markdown parser.\r\n *\r\n * Original author: Johnny Broadway <johnny@johnnybroadway.com>\r\n * Website: https://gist.github.com/jbroadway/2836900\r\n * Inspiration:\r\n * - https://gist.github.com/plugnburn/f0d12e38b6416a77c098\r\n * - https://github.com/Chalarangelo/parse-md-js/blob/master/parsemd.js\r\n * - https://gist.github.com/plugnburn/f0d12e38b6416a77c098\r\n *\r\n * Author: Erik Vullings <erik.vullings@gmail.com>\r\n * Conversion from PHP to TypeScript, applying fixes and tests, adding more elements, and publishing to npm:\r\n * Website: https://github.com/erikvullings/slimdown-js\r\n * License: MIT\r\n *\r\n * Has been cut to fit\r\n *\r\n */\r\n\r\nconst blockquote = (_, __, item = '') =>\r\n  `\\n<blockquote>${item.trim()}</blockquote>`\r\n\r\nconst cleanUpUrl = (link) => link.replace(/<\\/?em>/g, '_')\r\n\r\nconst header = (_, match, h = '') => {\r\n  const level = match.length\r\n  return `<h${level}>${h.trim()}</h${level}>`\r\n}\r\n\r\n/* eslint-disable */\r\nconst rules = [\r\n  [/\\r\\n/g, '\\n'], // Remove \\r\r\n  [/\\n(#+)(.*)/g, header], // headers\r\n  [/!\\[([^\\[]*)\\]\\((?:javascript:)?([^\\)]+)\\)/g, '<img src=\\'$2\\' alt=\\'$1\\'>'], // images, invoked before links\r\n  [/\\[([^\\[]+)\\]\\((?:javascript:)?([^\\)]+)\\)/g, '<a href=\\'$2\\'>$1</a>'], // links\r\n  [/(\\*\\*)([\\s\\S]*?)\\1/g, '<strong>$2</strong>'], // bold\r\n  [/(\\*)([\\s\\S]*?)\\1/g, '<em>$2</em>'], // emphasis\r\n  [/\\~\\~([\\s\\S]*?)\\~\\~/g, '<del>$1</del>'], // del\r\n  [/\\:\\\"(.*?)\\\"\\:/g, '<q>$1</q>'], // quote\r\n  [/\\n\\s*```\\n([^]*?)\\n\\s*```\\s*\\n/g, '\\n<pre>$1</pre>'], // codeblock\r\n  [/\\n(&gt;|\\>)(.*)/g, blockquote], // blockquotes\r\n  [/<\\/blockquote>\\n<blockquote>/g, '\\n'], // fix extra blockquote\r\n  [/https?:\\/\\/[^\"']*/g, cleanUpUrl], // fix em in links\r\n]\r\n/* eslint-enable */\r\n\r\n/**\r\n * Render some Markdown into HTML.\r\n */\r\nconst render = (markdown) => {\r\n  markdown = `\\n${markdown}\\n`\r\n  rules.forEach(([regex, subst]) => {\r\n    markdown = markdown.replace(regex, subst)\r\n  })\r\n  return trimlinebreaks(markdown)\r\n}\r\n\r\nfunction trimlinebreaks (text) {\r\n  if (text.length === 0) return text\r\n  if (text[0] === '\\n' && text[text.length - 1] === '\\n') return text.slice(1, -1)\r\n  if (text[0] === '\\n') return text.slice(1)\r\n  if (text[text.length - 1] === '\\n') return text.slice(0, -1)\r\n  return text\r\n}\r\n\r\nmodule.exports = { render }\r\n","class GameObject {\r\n  static fillFromJSON (json, TheClass, ...args) {\r\n    const obj = new TheClass()\r\n    for (const it of Object.keys(json)) {\r\n      obj[it] = json[it]\r\n    }\r\n    return obj\r\n  }\r\n\r\n  toJSON () {\r\n    const obj = {}\r\n    for (const it of Object.keys(this)) {\r\n      obj[it] = this[it]\r\n    }\r\n    return obj\r\n  }\r\n}\r\n\r\nmodule.exports = GameObject\r\n","class PassageComponent {\r\n  constructor (body = document.body) {\r\n    this.body = body\r\n    this.element = document.createElement('div')\r\n    this.body.appendChild(this.element)\r\n    this.render = this.render.bind(this)\r\n  }\r\n\r\n  render (props) {\r\n    // This function could have been written with only one line:\r\n    //  this.element.innerHTML = html\r\n    //\r\n    // But we decided to also add some CSS and a cool fadein/fadeout effect.\r\n\r\n    const last = this.element\r\n    last.classList.toggle('fadeout')\r\n    setTimeout(() => {\r\n      this.element = document.createElement('div')\r\n      this.body.replaceChild(this.element, last)\r\n      this.element.classList.toggle('passage')\r\n      this.element.innerHTML = props.html\r\n      this.body.appendChild(this.element)\r\n      setTimeout(() => this.element.classList.toggle('fadein'), 20)\r\n    }, 300)\r\n  }\r\n}\r\n\r\nmodule.exports = PassageComponent\r\n","class MenuComponent {\r\n  constructor (body = document.body) {\r\n    this.body = body\r\n    this.element = document.createElement('header')\r\n    this.body.appendChild(this.element)\r\n    this.render = this.render.bind(this)\r\n  }\r\n\r\n  createButton (name, action, active) {\r\n    const wrap = document.createElement('li')\r\n    const link = document.createElement('a')\r\n    link.innerHTML = name\r\n    if (active) link.setAttribute('onclick', action)\r\n    else link.classList.toggle('link-disabled')\r\n    wrap.appendChild(link)\r\n    return wrap\r\n  }\r\n\r\n  createMenu (props) {\r\n    const menu = document.createElement('ul')\r\n    const items = props.map(e => this.createButton(e[0], e[1], e[2]))\r\n    for (const item of items) {\r\n      menu.appendChild(item)\r\n    }\r\n    return menu\r\n  }\r\n\r\n  render (props) {\r\n    const nav = document.createElement('nav')\r\n    const menu = this.createMenu([\r\n      ['RESTART', 'document.engine.restart()', true],\r\n      ['<< PREV', 'document.engine.undo()', document.engine.canUndo],\r\n      ['NEXT >>', 'document.engine.redo()', document.engine.canRedo]\r\n    ])\r\n\r\n    nav.appendChild(menu)\r\n\r\n    const last = this.element\r\n    this.element = document.createElement('header')\r\n    this.element.appendChild(nav)\r\n    this.body.replaceChild(this.element, last)\r\n  }\r\n}\r\n\r\nmodule.exports = MenuComponent\r\n","/* eslint-disable */\r\nexport function uuidv4 () {\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\r\n    return v.toString(16);\r\n  });\r\n}\r\n\r\n/* eslint-enable */\r\n\r\nexport function getBasename (path) {\r\n  if (typeof path !== 'string' || path === '') return 'Untitled'\r\n  return path.split('\\\\').pop().split('/').pop()\r\n}\r\n\r\n// To use with react-hotkeys library keyMap.\r\nexport function hotkeyString (hotkey) {\r\n  function isMacintosh () {\r\n    return window.navigator.platform.indexOf('Mac') > -1\r\n  }\r\n\r\n  function isWindows () {\r\n    return window.navigator.platform.indexOf('Win') > -1\r\n  }\r\n\r\n  function isLinux () {\r\n    return window.navigator.platform.indexOf('Linux') > -1\r\n  }\r\n\r\n  if (typeof hotkey === 'string') {\r\n    return hotkey.split('+').map(e => {\r\n      if (e === 'mod' && (isWindows() || isLinux())) e = 'ctrl'\r\n      if (e === 'mod' && isMacintosh()) e = 'command'\r\n      return e.slice(0, 1).toUpperCase() + e.slice(1)\r\n    }).join('+')\r\n  } else if (typeof hotkey === 'object') {\r\n    return hotkeyString(hotkey.sequence)\r\n  }\r\n}\r\n","import Emitter from 'tiny-emitter'\r\nimport { uuidv4 } from './utils'\r\nimport { Intent, Toaster } from '@blueprintjs/core'\r\nimport { session, preferences } from './store'\r\n\r\nconst emitter = new Emitter()\r\nconst toaster = Toaster.create()\r\nexport default emitter\r\n\r\n/* -------- Default events -------- */\r\n\r\nconst userAgent = navigator.userAgent.toLowerCase()\r\nexport const isElectron = userAgent.indexOf(' electron/') > -1\r\n\r\nfunction sendMessage (title, content = {}, from = '') {\r\n  window.api.send('toMain', { uuid: uuidv4(), title: title, from: from, content: content })\r\n}\r\n\r\nif (isElectron) {\r\n  window.api.receive('fromMain', ({ uuid, from, title, content }) => {\r\n    switch (title) {\r\n      case 'set-path':\r\n        session.dispatch({ type: 'SET_PATH', path: content })\r\n        break\r\n      case 'set-text':\r\n        for (const [path, text] of content.texts) {\r\n          const index = session.getState().tabs.passive.findIndex((tab) => tab.path === path)\r\n          if (index >= 0) session.dispatch({ type: 'SWITCH_TAB', key: session.getState().tabs.passive[index].key, content: text })\r\n          else session.dispatch({ type: 'ADD_TAB', path: path, text: text })\r\n        }\r\n        break\r\n      case 'open-folder-dialog':\r\n        emitter.emit('open-folder-dialog-reply', content.from, content.path)\r\n        break\r\n      case 'error':\r\n        toaster.show({ message: 'Error: ' + content, intent: Intent.DANGER })\r\n        break\r\n      case 'version':\r\n        session.dispatch({ type: 'SET_VERSION', version: content.version })\r\n        break\r\n      default:\r\n        throw new Error('Invalid title on message from main process')\r\n    }\r\n  })\r\n\r\n  emitter.on('open-document', () => {\r\n    sendMessage('open-document')\r\n  })\r\n\r\n  emitter.on('save-document', (path, text) => {\r\n    session.dispatch({ type: 'CONTENT_TOGGLE_MODIFIED', modified: false })\r\n    sendMessage('save-document', { path: path, text: text })\r\n  })\r\n\r\n  emitter.on('save-document-as', (path, text) => {\r\n    session.dispatch({ type: 'CONTENT_TOGGLE_MODIFIED', modified: false })\r\n    sendMessage('save-document-as', { path: path, text: text })\r\n  })\r\n\r\n  emitter.on('close-app', () => {\r\n    session.dispatch({ type: 'FLUSH' })\r\n    sendMessage('close-app')\r\n  })\r\n  emitter.on('run-project', (path) => sendMessage('run-command', { path: path, command: preferences.getState().commands.run }))\r\n  emitter.on('build-project', (path) => sendMessage('run-command', { path: path, command: preferences.getState().commands.build }))\r\n  emitter.on('open-folder-dialog', (from) => sendMessage('open-folder-dialog', { from: from }))\r\n  emitter.on('new-project', (name, path) => sendMessage('new-project', { name: name, path: path }))\r\n  emitter.on('set-app-zoom', (factor) => sendMessage('set-zoom', { factor: factor }))\r\n\r\n  window.addEventListener('keyup', (event) => {\r\n    if (event.ctrlKey && event.altKey && event.key === 'i') {\r\n      window.api.send('toMain', { uuid: uuidv4(), title: 'toggle-devtools', from: '', content: {} })\r\n    }\r\n  }, true)\r\n}\r\n\r\nif (!isElectron) {\r\n  emitter.on('save-document', (path, text) => {\r\n    if (path === undefined) {\r\n      emitter.emit('show-rename', text)\r\n    } else {\r\n      session.dispatch({ type: 'CONTENT_TOGGLE_MODIFIED', modified: false })\r\n    }\r\n  })\r\n}\r\n\r\nemitter.on('warning', (message) => {\r\n  toaster.show({ message: 'Warning: ' + message, intent: Intent.WARNING })\r\n})\r\n\r\nemitter.on('error', (message) => {\r\n  toaster.show({ message: 'Error: ' + message, intent: Intent.DANGER })\r\n})\r\n\r\nemitter.on('wip', (message) => {\r\n  toaster.show({ message: 'WIP: Not implemented yet!', intent: Intent.WARNING, icon: 'build' })\r\n})\r\n\r\ndocument.clearPreferences = function () {\r\n  preferences.dispatch({ type: 'CLEAR' })\r\n}\r\n\r\ndocument.clearSession = function () {\r\n  session.dispatch({ type: 'CLEAR' })\r\n}\r\n","import Emitter from 'tiny-emitter'\r\nimport { getBasename, uuidv4 } from './utils'\r\nimport produce from 'immer'\r\nimport emitter, { isElectron } from './emitter'\r\nimport lodash from 'lodash'\r\n\r\nexport class Store {\r\n  constructor (reducer, initialState, localStorageKey = '') {\r\n    this.emitter = new Emitter()\r\n    this._state = initialState\r\n    this._reducer = reducer\r\n    this.localStorageKey = localStorageKey\r\n    this.dispatch.bind(this)\r\n    this.getState.bind(this)\r\n\r\n    if (this.localStorageKey) {\r\n      const state = JSON.parse(window.localStorage.getItem(this.localStorageKey))\r\n      if (state) this._state = state\r\n    }\r\n  }\r\n\r\n  dispatch (action) {\r\n    this._state = this._reducer(this._state, action)\r\n    if (this.localStorageKey) window.localStorage.setItem(this.localStorageKey, JSON.stringify(this._state))\r\n    this.emitter.emit('set-state')\r\n  }\r\n\r\n  getState () {\r\n    return this._state\r\n  }\r\n}\r\n\r\nfunction blanktab () {\r\n  return {\r\n    key: uuidv4(), // The key used for <TextEditor>, hopefully with it we will recover it's non-serializable state (like history)\r\n    path: undefined, // Absolute filepath to file, including extension.\r\n    text: '', // The current value, as plain text.\r\n    modified: false, // Whether there are unsaved changes.\r\n    dirty: false // Whether the text field contains the actual current value of the editor or needs to be flushed.\r\n  }\r\n}\r\n\r\nconst sessionInitialState = {\r\n  app: {\r\n    version: undefined\r\n  },\r\n  tabs: isElectron ? {\r\n    active: blanktab(),\r\n    passive: []\r\n  } : {\r\n    active: {\r\n      key: '1234',\r\n      path: 'main.utf8',\r\n      text: 'AAA',\r\n      modified: false,\r\n      dirty: false\r\n    },\r\n    passive: [{\r\n      key: '1234',\r\n      path: 'main.utf8',\r\n      text: 'AAA',\r\n      modified: false,\r\n      dirty: false\r\n    }]\r\n  }\r\n}\r\n\r\nconst preferencesInitialState = {\r\n  editor: {\r\n    fontFamily: 'Arial, Helvetica, sans-serif',\r\n    fontSize: 16\r\n  },\r\n  app: {\r\n    zoom: 1.0,\r\n    saveSession: false\r\n  },\r\n  commands: {\r\n    run: 'npm run start',\r\n    build: 'npm run build'\r\n  }\r\n}\r\n\r\nfunction preferencesReducer (state, action) {\r\n  switch (action.type) {\r\n    case 'MERGE': return produce(state, draft => {\r\n      lodash.merge(draft, action.value)\r\n    })\r\n    case 'SET': return produce(state, draft => {\r\n      lodash.set(draft, action.key, action.value)\r\n    })\r\n    case 'CLEAR': return produce(state, draft => {\r\n      window.localStorage.clear()\r\n      return preferencesInitialState\r\n    })\r\n    default: return state\r\n  }\r\n}\r\n\r\nfunction sessionReducer (state, action) {\r\n  function flush (state, draft) {\r\n    if (state.tabs.active.dirty) {\r\n      emitter.emit('get-text', (text) => {\r\n        draft.tabs.active.text = text\r\n        draft.tabs.active.dirty = false\r\n      })\r\n    }\r\n  }\r\n\r\n  function copyback (state, draft) {\r\n    if (state.tabs.active.path !== undefined) {\r\n      const index = state.tabs.passive.findIndex((tab) => tab.key === state.tabs.active.key)\r\n      if (index >= 0) {\r\n        flush(state, draft)\r\n        draft.tabs.passive[index] = draft.tabs.active\r\n      } else {\r\n        draft.tabs.passive.push(state.tabs.active)\r\n      }\r\n    }\r\n  }\r\n\r\n  switch (action.type) {\r\n    case 'SET_VERSION': return produce(state, draft => {\r\n      draft.app.version = action.version\r\n    })\r\n    case 'SET_PATH': return produce(state, draft => {\r\n      document.title = getBasename(action.path) + ' - HyperSigil'\r\n      draft.tabs.active.path = action.path\r\n    })\r\n    case 'FLUSH': return produce(state, draft => {\r\n      flush(state, draft)\r\n    })\r\n    case 'CLEAR': return produce(state, draft => {\r\n      return sessionInitialState\r\n    })\r\n    case 'CONTENT_TOGGLE_MODIFIED': return produce(state, draft => {\r\n      const mod = action.modified === undefined ? !draft.tabs.active.modified : action.modified\r\n      if (mod === true && !document.title.startsWith('*')) document.title = '*' + document.title\r\n      if (mod === false && document.title.startsWith('*')) document.title = document.title.slice(1)\r\n      draft.tabs.active.modified = mod\r\n      if (mod) draft.tabs.active.dirty = true\r\n      else copyback(state, draft)\r\n    })\r\n    case 'CONTENT_NEW': return produce(state, draft => {\r\n      if (document.title.startsWith('*')) document.title = document.title.slice(1)\r\n      copyback(state, draft)\r\n      draft.tabs.active = blanktab()\r\n    })\r\n    case 'ADD_TAB': return produce(state, draft => {\r\n      if (document.title.startsWith('*')) document.title = document.title.slice(1)\r\n      copyback(state, draft)\r\n      draft.tabs.active = {\r\n        key: uuidv4(),\r\n        path: action.path,\r\n        text: action.text,\r\n        modified: false,\r\n        dirty: false\r\n      }\r\n      draft.tabs.passive.push(draft.tabs.active)\r\n    })\r\n    case 'REMOVE_TAB': return produce(state, draft => {\r\n      if (state.tabs.active.key === action.key) {\r\n        const index = draft.tabs.passive.findIndex((tab) => tab.key === action.key)\r\n        if (index + 1 < state.tabs.passive.length) draft.tabs.active = state.tabs.passive[index + 1]\r\n        else if (index - 1 >= 0) draft.tabs.active = state.tabs.passive[index - 1]\r\n        else {\r\n          draft.tabs.active = blanktab()\r\n        }\r\n      }\r\n      draft.tabs.passive = draft.tabs.passive.filter((tab) => tab.key !== action.key)\r\n    })\r\n    case 'SWITCH_TAB': return produce(state, draft => {\r\n      copyback(state, draft)\r\n      const index = draft.tabs.passive.findIndex((tab) => tab.key === action.key)\r\n      if (action.content) {\r\n        draft.tabs.passive[index].text = action.content\r\n        if (draft.tabs.passive[index].modified) emitter.emit('warning', `On file ${draft.tabs.passive[index].path} content has been overwritten.`)\r\n\r\n        // We do this to update the textEditorComponent, however by doing this we destroy the history.\r\n        if (draft.tabs.passive[index].key === draft.tabs.active.key) draft.tabs.passive[index].key = uuidv4()\r\n\r\n        draft.tabs.passive[index].modified = false\r\n      }\r\n      draft.tabs.active = draft.tabs.passive[index]\r\n    })\r\n    default: return state\r\n  }\r\n}\r\n\r\nexport const preferences = new Store(preferencesReducer, preferencesInitialState, 'preferences')\r\nexport const session = new Store(sessionReducer, sessionInitialState, preferences.getState().app.saveSession ? 'session' : '')\r\n\r\nemitter.emit('set-app-zoom', preferences.getState().app.zoom)\r\n","import { useEffect, useState } from 'react'\r\nimport emitter from './emitter'\r\nimport lodash from 'lodash'\r\n\r\nexport function useEvent (name, func, deps = []) {\r\n  useEffect(() => {\r\n    emitter.on(name, func)\r\n    return () => emitter.off(name, func)\r\n  }, [name, func, ...deps])\r\n}\r\n\r\nexport function useSelector (store, selector) {\r\n  const init = selector ? lodash.get(store.getState(), selector) : store.getState()\r\n  const [value, setValue] = useState(init)\r\n  useEffect(() => {\r\n    const func = () => {\r\n      if (selector) {\r\n        const newvalue = lodash.get(store.getState(), selector)\r\n        if (newvalue !== value) setValue(newvalue)\r\n      } else {\r\n        setValue(store.getState())\r\n      }\r\n    }\r\n    store.emitter.on('set-state', func)\r\n    return () => emitter.off('set-state', func)\r\n  }, [store, selector, value])\r\n  return value\r\n}\r\n\r\nexport function useWindowSize () {\r\n  const [windowSize, setWindowSize] = useState({\r\n    width: window.innerWidth,\r\n    height: window.innerHeight\r\n  })\r\n\r\n  useEffect(() => {\r\n    function handleResize () {\r\n      setWindowSize({\r\n        width: window.innerWidth,\r\n        height: window.innerHeight\r\n      })\r\n    }\r\n\r\n    window.addEventListener('resize', handleResize)\r\n    handleResize()\r\n    return () => window.removeEventListener('resize', handleResize)\r\n  }, [])\r\n\r\n  return [windowSize.width, windowSize.height]\r\n}\r\n","import { useCallback } from 'react'\r\nimport { Text, Node } from 'slate'\r\nimport { Parser } from '@hypersigil/engine'\r\n\r\nconst parser = new Parser()\r\n\r\nfunction withSmallMarks (tokens) {\r\n  const tkl = []\r\n  for (const token of tokens) {\r\n    if (token.name.toLowerCase() === 'string') {\r\n      const re = /((\\n|^)[ ]*\\\\|\\\\[ ]*(\\n|$))|(\\n|^)(#+)|\\*/g\r\n      let match\r\n      while ((match = re.exec(token.value)) != null) {\r\n        tkl.push({\r\n          name: 'mark',\r\n          value: match[0],\r\n          start: {\r\n            offset: token.start.offset + match.index,\r\n            line: token.line,\r\n            column: token.column + match.index\r\n          },\r\n          end: {\r\n            offset: token.start.offset + match.index + match[0].length,\r\n            line: token.line,\r\n            column: token.column + match.index + match[0].length\r\n          }\r\n        })\r\n      }\r\n    } else tkl.push(token)\r\n  }\r\n  return tkl\r\n}\r\n\r\nexport function useDecorator (value) {\r\n  return useCallback(([node, path]) => {\r\n    if (!Text.isText(node)) return []\r\n    if (Node.get({ children: value }, path.slice(0, -1)).type !== 'HyperSigil') return []\r\n    const ranges = []\r\n    const expressionNames = [\r\n      'CallSymbol', 'Name', 'Operator', 'SetOperator', 'Number',\r\n      'IO', 'IC', 'BO', 'BC'\r\n    ]\r\n\r\n    const tokens = withSmallMarks(parser.tokenize(node.text, true))\r\n    for (const token of tokens) {\r\n      const isExpression = expressionNames.includes(token.name)\r\n      const isAdjacent = ranges.length > 0 && ranges[ranges.length - 1].focus.offset === token.start.offset\r\n      if (isExpression && isAdjacent && ranges[ranges.length - 1].name === 'expression') {\r\n        ranges[ranges.length - 1].focus.offset = token.end.offset\r\n      } else {\r\n        ranges.push({\r\n          name: isExpression ? 'expression' : token.name,\r\n          anchor: { path: path, offset: token.start.offset },\r\n          focus: { path: path, offset: token.end.offset }\r\n        })\r\n      }\r\n    }\r\n    return ranges\r\n  }, [parser, value])\r\n}\r\n\r\n// -- IO ----------------------------------------------------------------------\r\n\r\nexport function serialize (file) {\r\n  return parser.parseFile('#', file, true).map(passage => {\r\n    return {\r\n      type: 'Passage',\r\n      children: [\r\n        ...(passage.name === '#.default' && passage.yaml.passage.fakefront ? [] : [\r\n          { type: 'YAML', children: [{ text: passage.front.slice(0, -1) }] }\r\n        ]),\r\n        { type: 'HyperSigil', children: [{ text: passage.text }] }\r\n      ]\r\n    }\r\n  })\r\n}\r\n\r\nexport function deserialize (value) {\r\n  return value.map(passage => {\r\n    const text = []\r\n    for (const node of passage.children) {\r\n      if (node.type === 'YAML') text.push('---\\n' + node.children[0].text + '\\n---')\r\n      if (node.type === 'HyperSigil') text.push(node.children[0].text)\r\n    }\r\n    return text.join('\\n')\r\n  }).join('\\n')\r\n}\r\n","import React, { useState, useCallback, useMemo } from 'react'\r\nimport { Slate, Editable, withReact, ReactEditor } from 'slate-react'\r\nimport { createEditor, Transforms, Node, Element } from 'slate'\r\nimport { withHistory } from 'slate-history'\r\nimport './index.css'\r\nimport { session, preferences } from '../store'\r\nimport { useEvent, useSelector } from '../hooks'\r\nimport { deserialize, useDecorator } from './dataio'\r\n\r\nfunction withPassages (Editor) {\r\n  const { normalizeNode } = Editor\r\n\r\n  /**\r\n   * Notice how Normalization is required.\r\n   * @param  {[type]} editor [description]\r\n   * @return {[type]}        [description]\r\n   */\r\n  Editor.insertPassage = function insertPassage (editor) {\r\n    const node = (editor.selection ? Node.descendant(editor, editor.selection.anchor.path.slice(0, 2)) : undefined)\r\n    const attrs = (node === undefined || (node !== undefined && node.type !== 'HyperSigil'))\r\n      ? { at: [editor.selection.anchor.path[0] + 1] }\r\n      : { mode: 'highest' }\r\n    Transforms.insertNodes(editor, [{\r\n      type: 'Passage',\r\n      children: [\r\n        { type: 'YAML', children: [{ text: `passage:\\n${tabSpaces(editor, 4)}name: ` }] },\r\n        { type: 'HyperSigil', children: [{ text: '\\n' }] }\r\n      ]\r\n    }], { ...attrs })\r\n    Transforms.select(editor, [editor.selection.anchor.path[0], 0, 0])\r\n    Transforms.collapse(editor, { edge: 'focus' })\r\n  }\r\n\r\n  Editor.removePassage = function removePassage (editor) {\r\n    if (!editor.selection) return\r\n    const path = [editor.selection.anchor.path[0]]\r\n    Transforms.removeNodes(editor, { at: path })\r\n    if (path[0] === 0 && editor.children.length === 0) {\r\n      Transforms.insertNodes(Editor, [{\r\n        type: 'Passage',\r\n        children: [\r\n          { type: 'HyperSigil', children: [{ text: '' }] }\r\n        ]\r\n      }], { mode: 'highest' })\r\n    }\r\n  }\r\n\r\n  Editor.normalizeNode = function (entry) {\r\n    const [node, path] = entry\r\n\r\n    if (Element.isElement(node) && node.type === 'Passage') {\r\n      if (node.children.length >= 2) {\r\n        // Check if there are two consecutive HyperSigil or YAML nodes and merge them.\r\n        for (let i = 1; i < node.children.length; i++) {\r\n          if (node.children[i - 1].type === node.children[i].type) {\r\n            Transforms.mergeNodes(Editor, { at: [path[0], i] })\r\n          }\r\n        }\r\n      } else if (node.children.length < 2) {\r\n        if (path[0] !== 0) {\r\n          if (node.children.length === 1 && node.children[0].type === 'YAML') {\r\n            // If this is not the first passage, and it has only one YAML block, remove the passage.\r\n            Transforms.removeNodes(Editor, { at: path })\r\n          } else {\r\n            // If it has a HyperSigil block or the like, merge with the passage avobe.\r\n            Transforms.mergeNodes(Editor, { at: path })\r\n          }\r\n        } else {\r\n          if (node.children[0].type !== 'HyperSigil') {\r\n            // If this is the first passage and only contains one block wich is not HyperSigil (like YAML),\r\n            // remove it and insert an HyperSigil block instead.\r\n            Transforms.delete(Editor, { at: [path[0], 0, 0] })\r\n            Transforms.setNodes(Editor, { type: 'HyperSigil' }, { at: [path[0], 0] })\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (Editor.children.length === 0) {\r\n      console.log('NORMALIZATION (on empty editor): Inserting empty default passage')\r\n      Transforms.insertNodes(Editor, [{\r\n        type: 'Passage',\r\n        children: [\r\n          { type: 'HyperSigil', children: [{ text: '' }] }\r\n        ]\r\n      }], { mode: 'highest' })\r\n    }\r\n\r\n    // Fall back to the original `normalizeNode` to enforce other constraints.\r\n    normalizeNode(entry)\r\n  }\r\n\r\n  return Editor\r\n}\r\n\r\nexport function TextEditor ({ initialText }) {\r\n  const pref = useSelector(preferences, 'editor')\r\n  const [value, setValue] = useState(initialText)\r\n  const editor = useMemo(() => withPassages(withHistory(withReact(createEditor()))), [])\r\n  const renderLeaf = useCallback(props => <Leaf {...props} />)\r\n  const keyDownHandler = useKeyDownHandler(editor)\r\n  const decorate = useDecorator(value)\r\n\r\n  useEvent('get-text', (reply) => {\r\n    reply(deserialize(value))\r\n  })\r\n\r\n  useEvent('insert-passage', () => editor.insertPassage(editor))\r\n  useEvent('remove-passage', () => editor.removePassage(editor))\r\n\r\n  const renderElement = useCallback(({ attributes, children, element }) => {\r\n    switch (element.type) {\r\n      case 'YAML':\r\n        return <div {...attributes} className='yaml'>\r\n          <hr contentEditable={false} style={{ userSelect: 'none' }}/>\r\n          <div className='yaml-content'>{children}</div>\r\n          <hr contentEditable={false} style={{ userSelect: 'none' }}/>\r\n        </div>\r\n      case 'HyperSigil':\r\n        return <div className='hypersigil-content' {...attributes}>{children}</div>\r\n      case 'Passage':\r\n        return <div {...attributes}>{children}</div>\r\n      default:\r\n        return <div {...attributes}>{children}</div>\r\n    }\r\n  })\r\n\r\n  return (\r\n    <Slate editor={editor} value={value} onChange={value => setValue(value)} spellcheck=\"false\">\r\n      <Editable\r\n        style={{ fontFamily: pref.fontFamily, fontSize: `${pref.fontSize}px` }}\r\n        tabIndex='1'\r\n        autoFocus\r\n        className='slate-editable-hs mousetrap'\r\n        decorate={decorate}\r\n        renderElement={renderElement}\r\n        renderLeaf={renderLeaf}\r\n        placeholder=\"Write your passage here...\"\r\n        onKeyDown={keyDownHandler}\r\n        onSelect={(e) => {\r\n          // FIXME: THIS IS A HOTFIX FOR SCROLLING, TO BE REMOVED LATER\r\n          /**\r\n           * Chrome doesn't scroll at bottom of the page. This fixes that.\r\n           */\r\n          if (!(window).chrome) return\r\n          if (editor.selection == null) return\r\n          try {\r\n            /**\r\n             * Need a try/catch because sometimes you get an error like:\r\n             *\r\n             * Error: Cannot resolve a DOM node from Slate node: {\"type\":\"p\",\"children\":[{\"text\":\"\",\"by\":-1,\"at\":-1}]}\r\n             */\r\n            const domPoint = ReactEditor.toDOMPoint(\r\n              editor,\r\n              editor.selection.focus\r\n            )\r\n            const node = domPoint[0]\r\n            if (node == null) return\r\n            const element = node.parentElement\r\n            if (element == null) return\r\n            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' })\r\n          } catch (e) {\r\n            /**\r\n             * Empty catch. Do nothing if there is an error.\r\n             */\r\n          }\r\n        }}\r\n      />\r\n    </Slate>\r\n  )\r\n}\r\n\r\nexport function Leaf ({ attributes, children, leaf }) {\r\n  return (\r\n    <span\r\n      spellCheck={leaf.name !== 'expression'}\r\n      className={leaf.name}\r\n      {...attributes}\r\n    >\r\n      {children}\r\n    </span>\r\n  )\r\n}\r\n\r\nfunction tabSpaces (editor, num) {\r\n  const prefix = getPrefix(editor)\r\n  return ' '.repeat(num - prefix.length % num)\r\n}\r\n\r\nfunction getPrefix (editor, start = '\\n') {\r\n  if (!editor.selection) return ''\r\n  const node = Node.descendant(editor, editor.selection.anchor.path)\r\n  const before = node.text.slice(0, editor.selection.focus.offset)\r\n  const index = before.lastIndexOf(start)\r\n  return before.slice(index === -1 ? 0 : index + start.length)\r\n}\r\n\r\nconst ignoreKeys = [16, 18, 20, 27, 35, 36, 37, 38, 39, 40, 91, 93, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 144, 174, 175]\r\nfunction useKeyDownHandler (editor) {\r\n  return useCallback(event => {\r\n    if (!event.ctrlKey && !event.metaKey && !ignoreKeys.includes(event.keyCode)) {\r\n      session.dispatch({ type: 'CONTENT_TOGGLE_MODIFIED', modified: true })\r\n    }\r\n\r\n    switch (event.key) {\r\n      case 'Tab': {\r\n        event.preventDefault()\r\n        editor.insertText(tabSpaces(editor, 4))\r\n        break\r\n      }\r\n      case 'Enter': {\r\n        event.preventDefault()\r\n        const match = getPrefix(editor).match(/^[--]-+/g)\r\n        if (match) {\r\n          Transforms.delete(editor, { distance: match[0].length, reverse: true })\r\n          editor.insertPassage(editor)\r\n        } else editor.insertText('\\n')\r\n        break\r\n      }\r\n      case '{': {\r\n        event.preventDefault()\r\n        editor.insertText('{}')\r\n        Transforms.move(editor, { distance: 1, unit: 'offset', reverse: true })\r\n        break\r\n      }\r\n      default: break\r\n    }\r\n  }, [editor])\r\n}\r\n","import React from 'react'\r\nimport emitter from '../emitter'\r\n\r\nexport class ErrorBoundary extends React.Component {\r\n  constructor (props) {\r\n    super(props)\r\n    this.state = { hasError: false }\r\n  }\r\n\r\n  static getDerivedStateFromError (errora) {\r\n    return { hasError: true }\r\n  }\r\n\r\n  componentDidCatch (error, errorInfo) {\r\n    emitter.emit('error', error.message)\r\n  }\r\n\r\n  render () {\r\n    if (!this.state.hasError) {\r\n      return this.props.children\r\n    }\r\n    return null\r\n  }\r\n}\r\n","import React from 'react'\r\nimport { TextEditor } from './textEditor'\r\nimport { Scrollbars } from 'react-custom-scrollbars'\r\nimport { useWindowSize, useSelector } from '../hooks'\r\nimport { session } from '../store'\r\nimport { serialize } from './dataio'\r\nimport { ErrorBoundary } from '../components/errorBoundary'\r\n\r\nexport function TextEditorManager () {\r\n  const [, windowHeight] = useWindowSize()\r\n  const active = useSelector(session, 'tabs.active')\r\n\r\n  return (\r\n    <ErrorBoundary>\r\n      <Scrollbars style={{ height: windowHeight - 32 }}>\r\n        <TextEditor key={active.key} initialText={serialize(active.text)} />\r\n      </Scrollbars>\r\n    </ErrorBoundary>\r\n  )\r\n}\r\n","import React from 'react'\r\nimport { Classes, Icon, Popover, Button, Position, PopoverInteractionKind, Alignment, HTMLTable } from '@blueprintjs/core'\r\nimport { useWindowSize, useSelector } from '../hooks'\r\nimport { session } from '../store'\r\nimport { getBasename } from '../utils'\r\n\r\nfunction iconName (active, modified, key) {\r\n  if (active.key === key) modified = active.modified\r\n  if (modified && active.key === key) return 'selection'\r\n  if (modified && active.key !== key) return 'dot'\r\n  if (!modified && active.key === key) return 'circle'\r\n  return 'blank'\r\n}\r\n\r\nexport function Tab ({ dataKey, text, icon }) {\r\n  return (\r\n    <tr>\r\n      <td className='crossButton'>\r\n        <Button\r\n          minimal icon='small-cross'\r\n          onClick={() => session.dispatch({ type: 'REMOVE_TAB', key: dataKey })}\r\n        />\r\n      </td>\r\n      <td>\r\n        <Button\r\n          minimal fill alignText={Alignment.LEFT}\r\n          text={\r\n            <div className='main-menu-filepath' style={{ maxWidth: '200px', minWidth: '100px' }}>\r\n              {text}\r\n            </div>}\r\n          onClick={() => session.dispatch({ type: 'SWITCH_TAB', key: dataKey })}\r\n          rightIcon={<Icon icon={icon || 'blank'} color='#BFCCD6'/>}\r\n        />\r\n      </td>\r\n    </tr>\r\n  )\r\n}\r\n\r\nexport function Tabs () {\r\n  const active = useSelector(session, 'tabs.active')\r\n  const passive = useSelector(session, 'tabs.passive')\r\n  const [windowWidth] = useWindowSize()\r\n\r\n  return (\r\n    <Popover interactionKind={PopoverInteractionKind.HOVER} position={Position.BOTTOM} content={\r\n      <HTMLTable className='tabs-filetable'>\r\n        <tbody>\r\n          {\r\n            passive.length > 0 ? passive.map((tab) => {\r\n              return <Tab key={tab.key} dataKey={tab.key} text={getBasename(tab.path)} icon={iconName(active, tab.modified, tab.key)} />\r\n            }) : <div style={{ padding: '20px' }}>Empty</div>\r\n          }\r\n        </tbody>\r\n      </HTMLTable>\r\n    } target={\r\n      <div\r\n        className={`${Classes.MINIMAL} ${Classes.BUTTON} main-menu-filepath`}\r\n        style={{ maxWidth: Math.min(400, windowWidth - 220) }}\r\n      >\r\n        {((active.modified === true) ? '*' : '') + (active.path === undefined ? 'Untitled' : active.path)}\r\n      </div>\r\n    } />\r\n  )\r\n}\r\n","import Mousetrap from 'mousetrap'\r\nimport { useEffect } from 'react'\r\n\r\nMousetrap.prototype.stopCallback = function (e, element, combo) {\r\n  return false\r\n}\r\n\r\nexport function GlobalHotKeys (props) {\r\n  useEffect(() => {\r\n    for (const key of Object.keys(props.keyMap)) {\r\n      if (key in props.handlers) Mousetrap.bind(props.keyMap[key].sequence, props.handlers[key])\r\n    }\r\n    return () => {\r\n      for (const key of Object.keys(props.keyMap)) {\r\n        if (key in props.handlers) Mousetrap.unbind(props.keyMap[key].sequence)\r\n      }\r\n    }\r\n  })\r\n  return null\r\n}\r\n","import React from 'react'\r\nimport { Button, Popover, Menu, Position, ButtonGroup } from '@blueprintjs/core'\r\nimport './App.css'\r\nimport emitter, { isElectron } from '../emitter'\r\nimport { GlobalHotKeys } from './globalHotKeys'\r\nimport { hotkeyString } from '../utils'\r\n\r\nimport { session } from '../store'\r\n\r\nconst keyMap = {\r\n  NEW_DOCUMENT: {\r\n    name: 'Create a new document',\r\n    sequence: 'mod+n'\r\n  },\r\n  OPEN_DOCUMENT: {\r\n    name: 'Open an existing document',\r\n    sequence: 'mod+o'\r\n  },\r\n  SAVE_DOCUMENT: {\r\n    name: 'Save the document to a file',\r\n    sequence: 'mod+s'\r\n  },\r\n  SAVE_DOCUMENT_AS: {\r\n    name: 'Save the document to a new file',\r\n    sequence: 'mod+shift+s'\r\n  },\r\n  EXIT_APP: {\r\n    name: 'Close the application',\r\n    sequence: 'mod+shift+q'\r\n  }\r\n}\r\n\r\nexport function MainMenu () {\r\n  const handlers = {\r\n    NEW_DOCUMENT: newDocument,\r\n    OPEN_DOCUMENT: openDocument,\r\n    SAVE_DOCUMENT: saveDocument,\r\n    SAVE_DOCUMENT_AS: saveDocumentAs,\r\n    EXIT_APP: () => emitter.emit('close-app')\r\n  }\r\n\r\n  function newDocument () {\r\n    session.dispatch({ type: 'CONTENT_NEW' })\r\n  }\r\n\r\n  function openDocument () {\r\n    emitter.emit('open-document')\r\n  }\r\n\r\n  function saveDocument (e) {\r\n    if (!isElectron && e.key !== undefined) e.preventDefault()\r\n    emitter.emit('get-text',\r\n      (text) => emitter.emit('save-document', session.getState().tabs.active.path, text)\r\n    )\r\n  }\r\n\r\n  function saveDocumentAs () {\r\n    emitter.emit('get-text',\r\n      (text) => emitter.emit('save-document-as', session.getState().tabs.active.path, text)\r\n    )\r\n  }\r\n\r\n  function runProject () {\r\n    emitter.emit('run-project', session.getState().tabs.active.path)\r\n  }\r\n\r\n  function buildProject () {\r\n    emitter.emit('build-project', session.getState().tabs.active.path)\r\n  }\r\n\r\n  return (\r\n    <ButtonGroup minimal>\r\n      <Popover minimal position={Position.BOTTOM_LEFT} content={\r\n        <Menu>\r\n          <Menu.Item text=\"New\" label={hotkeyString(keyMap.NEW_DOCUMENT)} onClick={newDocument}/>\r\n          <Menu.Item text=\"New Project...\" onClick={() => emitter.emit('show-new-project')}/>\r\n          <Menu.Item text=\"Open...\" label={hotkeyString(keyMap.OPEN_DOCUMENT)} onClick={openDocument} disabled={!isElectron}/>\r\n          <Menu.Item text=\"Save\" label={hotkeyString(keyMap.SAVE_DOCUMENT)} onClick={saveDocument}/>\r\n          <Menu.Item text=\"Save As...\" label={hotkeyString(keyMap.SAVE_DOCUMENT_AS)} onClick={saveDocumentAs} disabled={!isElectron}/>\r\n          <Menu.Divider/>\r\n          <Menu.Item text=\"Run\" onClick={runProject} disabled={!isElectron}/>\r\n          <Menu.Item text=\"Build\" onClick={buildProject} disabled={!isElectron}/>\r\n          <Menu.Divider/>\r\n          <Menu.Item text=\"Preferences...\" onClick={() => emitter.emit('show-preferences')}/>\r\n          <Menu.Divider/>\r\n          <Menu.Item text=\"Exit\" label={hotkeyString(keyMap.EXIT_APP)} onClick={() => emitter.emit('close-app')} disabled={!isElectron}/>\r\n        </Menu>\r\n      } target={\r\n        <Button minimal small text=\"File\" />\r\n      } />\r\n      <Popover minimal position={Position.BOTTOM_LEFT} content={\r\n        <Menu>\r\n          <Menu.Item text=\"Undo\" onClick={() => emitter.emit('wip')}/>\r\n          <Menu.Item text=\"Redo\" onClick={() => emitter.emit('wip')}/>\r\n          <Menu.Divider/>\r\n          <Menu.Item text=\"Find...\" onClick={() => emitter.emit('wip')}/>\r\n          <Menu.Item text=\"Replace...\" onClick={() => emitter.emit('wip')}/>\r\n          <Menu.Divider/>\r\n          <Menu.Item text=\"Insert Passage\" onClick={() => emitter.emit('insert-passage')}/>\r\n          <Menu.Item text=\"Remove Passage\" onClick={() => emitter.emit('remove-passage')}/>\r\n        </Menu>\r\n      } target={\r\n        <Button minimal small text=\"Edit\" />\r\n      } />\r\n      <Popover minimal position={Position.BOTTOM_LEFT} content={\r\n        <Menu>\r\n          <Menu.Item text=\"Toggle Sidebar\" onClick={() => emitter.emit('wip')}/>\r\n        </Menu>\r\n      } target={\r\n        <Button minimal small text=\"View\" />\r\n      } />\r\n      <Popover minimal position={Position.BOTTOM_LEFT} content={\r\n        <Menu>\r\n          <Menu.Item text=\"About\" onClick={() => emitter.emit('show-about')}/>\r\n        </Menu>\r\n      } target={\r\n        <Button minimal small text=\"Help\" />\r\n      } />\r\n      <GlobalHotKeys keyMap={keyMap} handlers={handlers} />\r\n    </ButtonGroup>\r\n  )\r\n}\r\n","import React, { useState } from 'react'\r\nimport { Dialog, Classes } from '@blueprintjs/core'\r\nimport { useEvent, useSelector } from '../hooks'\r\nimport { session } from '../store'\r\n\r\nexport function AboutDialog () {\r\n  const [state, setState] = useState({\r\n    isOpen: false\r\n  })\r\n\r\n  const version = useSelector(session, 'app.version')\r\n  useEvent('show-about', () => setState({ isOpen: true }))\r\n\r\n  function handleClose () {\r\n    setState({ isOpen: false })\r\n  }\r\n\r\n  return (\r\n    <Dialog\r\n      title=\"HyperSigil Editor\"\r\n      className={Classes.DARK}\r\n      onClose={handleClose}\r\n      {...state}\r\n    >\r\n      <div className={`${Classes.DIALOG_BODY} ${Classes.RUNNING_TEXT}`}>\r\n        A text editor for the HyperSigil game engine, for creating HTML text-based games using JavaScript and the HyperSigil Template Engine.\r\n        <h4>Details</h4>\r\n        <p>Version: {version}</p>\r\n        <p>Copyright (C) Robert Planas - 2020</p>\r\n      </div>\r\n    </Dialog>\r\n  )\r\n}\r\n","import { isElectron } from '../emitter'\r\nimport React, { useState } from 'react'\r\nimport { preferences, session } from '../store'\r\nimport { useEvent, useSelector } from '../hooks'\r\nimport { Drawer, Classes, FormGroup, ControlGroup, Button, InputGroup, HTMLSelect, NumericInput, Switch } from '@blueprintjs/core'\r\n\r\nfunction Title (props) {\r\n  return (\r\n    <h4 style={{ margin: '0px 0px 16px 0px' }}>{props.children}</h4>\r\n  )\r\n}\r\n\r\nexport function Preferences () {\r\n  const [state, setState] = useState({\r\n    isOpen: false\r\n  })\r\n\r\n  const prefs = useSelector(preferences)\r\n\r\n  useEvent('show-preferences', () => setState({ isOpen: true }))\r\n  function handleClose () {\r\n    setState({ isOpen: false })\r\n  }\r\n\r\n  function setPref (key, value) {\r\n    preferences.dispatch({ type: 'SET', key: key, value: value })\r\n  }\r\n\r\n  return (\r\n    <Drawer\r\n      title=\"Preferences\"\r\n      className={Classes.DARK}\r\n      onClose={handleClose}\r\n      size='66%'\r\n      style={{ minWidth: '256px', maxWidth: '600px' }}\r\n      {...state}\r\n    >\r\n      <div className={`${Classes.DIALOG_BODY} ${Classes.RUNNING_TEXT}`}>\r\n        <Title>Editor</Title>\r\n        <FormGroup\r\n          label=\"Font-family and size\"\r\n          labelFor=\"text-input\"\r\n        >\r\n          <ControlGroup fill vertical={false}>\r\n            <HTMLSelect\r\n              value={prefs.editor.fontFamily}\r\n              onChange={e => setPref('editor.fontFamily', e.currentTarget.value)}\r\n            >\r\n              <option>{'Georgia, serif'}</option>\r\n              <option>{'\"Palatino Linotype\", \"Book Antiqua\", Palatino, serif'}</option>\r\n              <option>{'\"Times New Roman\", Times, serif'}</option>\r\n              <option>{'Arial, Helvetica, sans-serif'}</option>\r\n              <option>{'\"Arial Black\", Gadget, sans-serif'}</option>\r\n              <option>{'\"Comic Sans MS\", cursive, sans-serif'}</option>\r\n              <option>{'Impact, Charcoal, sans-serif'}</option>\r\n              <option>{'\"Lucida Sans Unicode\", \"Lucida Grande\", sans-serif'}</option>\r\n              <option>{'Tahoma, Geneva, sans-serif'}</option>\r\n              <option>{'\"Trebuchet MS\", Helvetica, sans-serif'}</option>\r\n              <option>{'Verdana, Geneva, sans-serif'}</option>\r\n              <option>{'\"Courier New\", Courier, monospace'}</option>\r\n              <option>{'\"Lucida Console\", Monaco, monospace'}</option>\r\n            </HTMLSelect>\r\n            <NumericInput fill min={8} max={128} minorStepSize={null}\r\n              value={prefs.editor.fontSize}\r\n              onValueChange={x => setPref('editor.fontSize', x)}\r\n            />\r\n          </ControlGroup>\r\n        </FormGroup>\r\n        <Title>Commands</Title>\r\n        <FormGroup\r\n          inline contentClassName='full-width'\r\n          label=\"Run\"\r\n        >\r\n          <InputGroup fill placeholder=\"npm run start\"\r\n            value={prefs.commands.run}\r\n            onChange={e => setPref('commands.run', e.target.value)}\r\n            disabled={!isElectron}\r\n          />\r\n        </FormGroup>\r\n        <FormGroup\r\n          inline contentClassName='full-width'\r\n          label=\"Build\"\r\n        >\r\n          <InputGroup fill placeholder=\"npm run build\"\r\n            value={prefs.commands.build}\r\n            onChange={e => setPref('commands.build', e.target.value)}\r\n            disabled={!isElectron}\r\n          />\r\n        </FormGroup>\r\n        <Title>Miscellaneous</Title>\r\n        <Switch checked={prefs.app.saveSession} onChange={e => {\r\n          setPref('app.saveSession', e.target.checked)\r\n          session.localStorageKey = (e.target.checked ? 'session' : '')\r\n        }}>\r\n        Restore session on startup\r\n        </Switch>\r\n        <Button fill onClick={() => preferences.dispatch({ type: 'CLEAR' })}>Restore Defaults</Button>\r\n      </div>\r\n    </Drawer>\r\n  )\r\n}\r\n","import React, { useState } from 'react'\r\nimport { Dialog, Classes, FormGroup, InputGroup, Button, Intent, FileInput } from '@blueprintjs/core'\r\nimport { useEvent } from '../hooks'\r\nimport emitter from '../emitter'\r\n\r\nexport function NewProjectDialog () {\r\n  const [state, setState] = useState({\r\n    isOpen: false\r\n  })\r\n\r\n  const [name, setName] = useState(undefined)\r\n  const [path, setPath] = useState(undefined)\r\n\r\n  useEvent('show-new-project', () => setState({ isOpen: true }))\r\n  useEvent('open-folder-dialog-reply', (from, xpath) => {\r\n    if (from === 'newProject' && typeof xpath === 'string') setPath(xpath)\r\n  })\r\n\r\n  function handleClose () {\r\n    setName(undefined)\r\n    setPath(undefined)\r\n    setState({ isOpen: false })\r\n  }\r\n\r\n  function handleCreate () {\r\n    if (name !== undefined && path !== undefined) {\r\n      emitter.emit('new-project', name, path)\r\n      handleClose()\r\n    } else emitter.emit('warning', 'Name and path are required')\r\n  }\r\n\r\n  return (\r\n    <Dialog\r\n      title=\"New Project\"\r\n      className={Classes.DARK}\r\n      onClose={handleClose}\r\n      {...state}\r\n    >\r\n      <div className={Classes.DIALOG_BODY}>\r\n        <FormGroup\r\n          label=\"Project Name\"\r\n          labelFor=\"text-input\"\r\n          labelInfo=\"(required)\"\r\n        >\r\n          <InputGroup id=\"text-input\" placeholder=\"My Amazing Game\" onChange={event => setName(event.target.value)}/>\r\n        </FormGroup>\r\n        <FormGroup\r\n          helperText=\"Final destination, files will be placed here, no subfolder will be created\"\r\n          label=\"Directory\"\r\n          labelFor=\"file-input\"\r\n          labelInfo=\"(required)\"\r\n        >\r\n          <FileInput\r\n            fill id=\"file-input\"\r\n            text={path === undefined ? 'Choose file...' : path}\r\n            hasSelection={path !== undefined}\r\n            inputProps={{ onClick: (event) => { event.preventDefault(); emitter.emit('open-folder-dialog', 'newProject') } }}\r\n          />\r\n        </FormGroup>\r\n      </div>\r\n      <div className={Classes.DIALOG_FOOTER}>\r\n        <div className={Classes.DIALOG_FOOTER_ACTIONS}>\r\n          <Button intent={Intent.NONE} onClick={handleClose}>Close</Button>\r\n          <Button intent={Intent.PRIMARY} onClick={handleCreate}>Create</Button>\r\n        </div>\r\n      </div>\r\n    </Dialog>\r\n  )\r\n}\r\n","import React, { useState } from 'react'\r\nimport { Dialog, Classes, Button, FormGroup, InputGroup, Intent } from '@blueprintjs/core'\r\nimport { useEvent } from '../hooks'\r\nimport { session } from '../store'\r\nimport emitter from '../emitter'\r\n\r\nexport function RenameDialog () {\r\n  const [isOpen, setIsOpen] = useState(false)\r\n  const [state, setState] = useState({\r\n    path: undefined,\r\n    text: undefined\r\n  })\r\n\r\n  useEvent('show-rename', (text) => {\r\n    setIsOpen(true)\r\n    setState({ path: undefined, text: text })\r\n  })\r\n\r\n  function handleClose () {\r\n    setIsOpen(false)\r\n    setState({ path: undefined, text: undefined })\r\n  }\r\n\r\n  function handleDone () {\r\n    const index = session.getState().tabs.passive.findIndex((tab) => tab.path === state.path)\r\n    if (!state.path || index >= 0) {\r\n      emitter.emit('warning', 'The name is empty or already being used by another file in the same path')\r\n    } else {\r\n      session.dispatch({ type: 'CONTENT_TOGGLE_MODIFIED', modified: false })\r\n      session.dispatch({ type: 'ADD_TAB', path: state.path, text: state.text })\r\n      handleClose()\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog\r\n      title=\"Rename file\"\r\n      className={Classes.DARK}\r\n      onClose={handleClose}\r\n      isOpen={isOpen}\r\n    >\r\n      <div className={Classes.DIALOG_BODY}>\r\n        <FormGroup\r\n          label=\"New name\"\r\n          labelFor=\"text-input\"\r\n        >\r\n          <InputGroup id=\"text-input\" placeholder=\"Untitled\" onChange={\r\n            event => {\r\n              setState({ path: event.target.value, text: state.text })\r\n            }\r\n          } inputRef={(element) => {\r\n            if (element) {\r\n              element.onkeydown = (event) => {\r\n                if (event.key === 'Enter') handleDone()\r\n              }\r\n            }\r\n          }}/>\r\n        </FormGroup>\r\n      </div>\r\n      <div className={Classes.DIALOG_FOOTER}>\r\n        <div className={Classes.DIALOG_FOOTER_ACTIONS}>\r\n          <Button intent={Intent.NONE} onClick={handleClose}>Close</Button>\r\n          <Button intent={Intent.PRIMARY} onClick={handleDone}>Rename</Button>\r\n        </div>\r\n      </div>\r\n    </Dialog>\r\n  )\r\n}\r\n","import React from 'react'\r\nimport { ButtonGroup, Button, Intent, Navbar, Alignment } from '@blueprintjs/core'\r\nimport emitter, { isElectron } from '../emitter'\r\nimport { Tabs } from './tabs'\r\nimport { MainMenu } from './mainMenu'\r\nimport { AboutDialog } from './aboutDialog'\r\nimport { Preferences } from './preferences'\r\nimport { NewProjectDialog } from './newProject'\r\nimport { RenameDialog } from './webDialogs'\r\n\r\nexport function TitleBar () {\r\n  return (\r\n    <div>\r\n      <Navbar className='bp3-dark smallnav' style={{ position: 'stiky', overflow: 'hidden' }}>\r\n        <Navbar.Group className='smallnav' align={Alignment.LEFT}>\r\n          <MainMenu />\r\n          <div className='win-draggable'></div>\r\n          <ButtonGroup>\r\n            <Tabs />\r\n            <div className='win-draggable' style={{ width: '20px' }}/>\r\n            {\r\n              isElectron &&\r\n              <Button minimal small icon='cross' intent={Intent.NONE} onClick={() => emitter.emit('close-app')}/>\r\n            }\r\n          </ButtonGroup>\r\n        </Navbar.Group>\r\n      </Navbar>\r\n      {/* <div className='smallnav'/> */}\r\n      <AboutDialog/>\r\n      <NewProjectDialog/>\r\n      <Preferences/>\r\n      <RenameDialog/>\r\n    </div>\r\n  )\r\n}\r\n","import React, { useState, useMemo } from 'react'\r\nimport { session } from '../store'\r\nimport { useSelector } from '../hooks'\r\nimport HyperSigil from '@hypersigil/engine'\r\nimport '@hypersigil/engine/style/standard.css'\r\n\r\ndocument.getElementsByTagName('body')[0].lang = 'en'\r\n\r\nfunction PreviewMenu () {\r\n  const Button = ({ name, action, active }) => (\r\n    <li>{\r\n      active ? <a onClick={action}>{name}</a> : <a className='link-disabled'>{name}</a>\r\n    }</li>\r\n  )\r\n\r\n  const Menu = (props) => (\r\n    <ul>\r\n      <Button name='RESTART' action={() => document.engine.restart()} active={true}/>\r\n      <Button name='<< PREV' action={() => document.engine.undo()} active={document.engine.canUndo}/>\r\n      <Button name='NEXT >>' action={() => document.engine.redo()} active={document.engine.canRedo}/>\r\n    </ul>\r\n  )\r\n\r\n  return <header><nav><Menu/></nav></header>\r\n}\r\n\r\nexport function PreviewComponent () {\r\n  const [text, setText] = useState('')\r\n  const tabs = useSelector(session, 'tabs.passive')\r\n  const files = {}\r\n  for (const tab of tabs) {\r\n    files[tab.path] = tab.text\r\n  }\r\n\r\n  useMemo(() => {\r\n    document.engine = new HyperSigil.Engine((html) => setText(html), files, {\r\n      initialPassage: 'main',\r\n      autoSave: false,\r\n      static: {}\r\n    })\r\n\r\n    document.engine.onPassageEnter = function (name) {\r\n      const f = document.engine.env.static.getState()\r\n      document.engine.env.local.push({\r\n        ...f.HyperSigil.Components,\r\n        ...f.HyperSigil.Standard,\r\n        ...f.HyperSigil.Documentation\r\n      })\r\n    }\r\n\r\n    document.engine.init()\r\n  }, [tabs])\r\n\r\n  return (\r\n    <div>\r\n      <PreviewMenu />\r\n      <div className='passage fadein' dangerouslySetInnerHTML={{ __html: text }} />\r\n    </div>\r\n  )\r\n}\r\n","import React from 'react'\r\nimport Split from 'react-split'\r\n\r\nimport { TextEditorManager } from './editor/textEditorManager'\r\nimport { TitleBar } from './components/titleBar'\r\nimport { PreviewComponent } from './components/preview'\r\n\r\nconst userAgent = navigator.userAgent.toLowerCase()\r\n\r\nfunction App () {\r\n  if (userAgent.indexOf(' electron/') > -1) {\r\n    return <div><TitleBar/><TextEditorManager/></div>\r\n  }\r\n  return (\r\n    <div>\r\n      <Split\r\n        style={{ display: 'flex' }}\r\n      >\r\n        <div>\r\n          <TitleBar/>\r\n          <TextEditorManager/>\r\n        </div>\r\n        <div>\r\n          <PreviewComponent/>\r\n        </div>\r\n      </Split>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default App\r\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport App from './App'\nimport * as serviceWorker from './serviceWorker'\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n)\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n\n// That's cool and all, but we're running it after webpack & within electron,\n// the app is already 100% offline!\nserviceWorker.unregister()\n","'use strict'\n\nconst { Parser, HyperSigil } = require('./parser')\nconst functions = require('./functions')\nconst util = require('./utils')\nconst YAML = require('yaml')\nconst Environment = require('./environment')\nconst lodash = require('lodash')\nconst slimdown = require('./slimdown')\nconst GameObject = require('./gameobject')\nconst AST = require('./AST')\nconst PassageComponent = require('./components/passageComponent')\nconst MenuComponent = require('./components/menuComponent')\n\nclass Engine {\n  /**\n   * Initialites the game engine\n   * @param  {Object} renderFunction The callback function that will be called with the new passage rendered contents. Use with elemnt.innerHTML or similar.\n   * @param  {Object} hyperSigilFiles Object such that keys are file paths and values are their contents, that is, passages.\n   * @param  {Object} options Object holding the options for this instance of the game engine.\n   */\n  constructor (renderFunction, hyperSigilFiles = {}, options = {}) {\n    this.render = renderFunction\n    this.env = new Environment({ ...functions, ...options.static })\n    this.options = options\n    this._currentPassageHTML = ''\n    this._isPassageLoading = false\n    this._evaluationDepth = 0\n    this.DOMCallbacks = {}\n    this.parser = new Parser()\n\n    this.passages = {}\n    for (const key in hyperSigilFiles) {\n      const passages = this.parser.parseFile(key, hyperSigilFiles[key])\n      for (const passage of passages) {\n        this.passages[passage.name] = passage\n      }\n    }\n\n    // Evnet handlers\n    this.onPassageEnter = (name) => {}\n    this.onPassageDone = (name) => {}\n    this.onPassageLeave = (name) => {}\n  }\n\n  init () {\n    let state = {}\n    for (const [name, passage] of Object.entries(this.passages)) {\n      const yaml = passage.yaml\n      state = lodash.merge(state, yaml.global)\n      state = lodash.merge(state, { passage: { name: 'NOPSG' }, game: { passages: { [name]: { ...yaml.passage, name: name } } } })\n    }\n\n    if (this.options.autoSave && window.localStorage.currentGame) {\n      this.env.load(JSON.parse(window.localStorage.currentGame))\n      this.goToPassage(this.env.global.getState().passage.name, true)\n    } else {\n      this.env.load(state)\n      this.goToPassage(this.initialPassageName)\n    }\n  }\n\n  get currentPassageHTML () {\n    return this._currentPassageHTML\n  }\n\n  set currentPassageHTML (text) {\n    this._currentPassageHTML = text\n    this.render(text)\n  }\n\n  get currentPassageName () {\n    return this.env.global.getState().passage.name\n  }\n\n  get initialPassageName () {\n    return this.options.initialPassage || 'main'\n  }\n\n  get isPassageLoading () {\n    return this._isPassageLoading\n  }\n\n  get canUndo () {\n    return this.env.global._internal.getState().past.length > 0\n  }\n\n  get canRedo () {\n    return this.env.global._internal.getState().future.length > 0\n  }\n\n  evaluateNode (root) {\n    const self = this\n    const map = {\n      String: () => lodash.escape(root.value),\n      Name: () => root.value,\n      Number: () => Number(root.value),\n      Block: () => root.getChildByName('All').value,\n      Text: function () {\n        self._evaluationDepth++\n        const output = []\n        for (const node of root.value) {\n          try {\n            output.push(self.evaluateNode(node))\n          } catch (err) {\n            if (self._evaluationDepth <= 1) {\n              console.error(`${err.name} in Call node at line ${node.tree.start.line} column ${node.tree.start.column}: ${err.message}`)\n              output.push(self.env.static.getState().HyperSigil.Components.error(err.message))\n            } else {\n              self._evaluationDepth--\n              throw err\n            }\n          }\n        }\n        self._evaluationDepth--\n        return util.trimByBackslash(\n          slimdown.render(output.join(''))\n        ).replace(/(?:\\r\\n|\\r|\\n)/g, '<br>')\n      },\n      Call: function () {\n        const func = self.evaluateNode(root.getChildByName('CallName'))\n        const args = self.evaluateNode(root.getChildByName('CallList'))\n        return (typeof func === 'function') ? func(...args) : func\n      },\n      CallName: function () {\n        const names = [root.getChildByName('Name')]\n          .concat(root.getChildByName('SubnameList').value)\n          .map(e => self.evaluateNode(e))\n        return (root.ref) ? names : self.env.get(names)\n      },\n      Index: function () {\n        return self.evaluateNode(root.getChildByName('Text'))\n      },\n      CallList: function () {\n        return root.value.map(e => self.evaluateNode(e))\n      },\n      Operand: function () {\n        return self.evaluateNode(root.value[0])\n      },\n      Operation: function () {\n        return {\n          operator: root.value[0].value,\n          operand: self.evaluateNode(root.value[1])\n        }\n      },\n      OperationList: function () {\n        return root.value.map(e => self.evaluateNode(e))\n      },\n      Expression: function () {\n        let a = self.evaluateNode(root.value[0])\n\n        const operations = self.evaluateNode(root.value[1]).map(op => {\n          const result = { op: op.operator, a: a, b: op.operand }\n          a = result.b\n          return result\n        })\n\n        return (operations.length) ? operations : [{ op: null, a: a, b: null }]\n      },\n      SetExpression: function () {\n        const nodeA = root.value[1]; nodeA.ref = true\n        const nodeB = self.evaluateNode(root.value[3])\n        const op = root.value[2].value\n        const path = document.engine.evaluateNode(nodeA)\n        const value = (root.value[3].value[0].name === 'Block') ? self.evaluate(nodeB).toString() : nodeB\n        if (op === '=') self.env.set(path, value)\n        else if (op === '+=') self.env.set(path, Number(self.env.get(path)) + value)\n        else if (op === '-=') self.env.set(path, Number(self.env.get(path)) - value)\n      }\n    }\n\n    if (root.name in map) return map[root.name]()\n    else throw SyntaxError(`On node ${root.name}`)\n  }\n\n  evaluate (passage, parserfunc) {\n    if (passage === undefined) throw new Error('Evaluate called with undefined')\n    const ast = this.parser.parse(passage, parserfunc)\n    return this.evaluateNode(ast)\n  }\n\n  goToPassage (name, forceflush = false) {\n    if (this.passageIsLoading) throw Error('A passage load can not be triggered when another passage is already loading')\n    try {\n      name = this.resolvePassageName(name)\n      if (this.onPassageLeave(name)) return\n      this._isPassageLoading = true\n      this._evaluationDepth = 0\n      this._DOMCallbacks = {}\n      const passage = this.passages[name]\n      this.env.next(name, forceflush)\n      if (this.options.autoSave) window.localStorage.setItem('currentGame', JSON.stringify(this.env.global.getState()))\n      this.onPassageEnter(name)\n      this.env.local.push()\n      this.currentPassageHTML = this.evaluate(passage.text)\n      this.env.local.pop()\n      this._isPassageLoading = false\n      this.onPassageDone(name)\n    } catch (err) {\n      this.currentPassageHTML = `<div style=\"margin: 10px 0px;padding:12px;color: #D8000C;background-color: #FFD2D2;\">${err.name} when loading passage ${name}: ${err.message}</div>`\n      this._isPassageLoading = false\n      throw err\n    }\n  }\n\n  undo () {\n    this.env.undo()\n    this.goToPassage(this.currentPassageName)\n  }\n\n  redo () {\n    this.env.redo()\n    this.goToPassage(this.currentPassageName)\n  }\n\n  restart () {\n    window.localStorage.removeItem('currentGame')\n    this.env.restart()\n    this.init()\n  }\n\n  getPathByCallName (name) {\n    const ast = (typeof name === 'string') ? this.parser.parse(name, HyperSigil.CallName) : name\n\n    // This line changes the behaviour of Engine.evaluateNode for nodes of type\n    // CallName allowing to return a path (array) instead of the final value.\n    ast.ref = true\n    return document.engine.evaluateNode(ast)\n  }\n\n  resolvePassageName (name) {\n    if (name === '' || name === '.') return this.currentPassageName\n    if (name.startsWith('.')) {\n      const prefix = this.currentPassageName.split('.')\n      const suffix = name.slice(1).split('.')\n      name = prefix.slice(0, suffix.length).concat(suffix).join('.')\n    }\n    if (name in this.passages) return name\n    if (name + '.default' in this.passages) return name + '.default'\n    throw Error(`Passage with name ${name} not found`)\n  }\n\n  addCallback (func) {\n    const id = util.uuidv4()\n    this.DOMCallbacks[id] = func\n    return id\n  }\n}\n\nmodule.exports = { Engine, GameObject, PassageComponent, MenuComponent, Environment, AST, YAML, Parser }\n","const lodash = require('lodash')\r\n\r\n/**\r\n * Class to operate with a Parsimmon generated Abstract Syntax Tree.\r\n *\r\n * Parsimmon is a parsing library for JavaScript. You can use .node() on a\r\n * parser to generate ASTNodes. Functions like .many() will generate arrays.\r\n * See: https://github.com/jneen/parsimmon/blob/master/API.md\r\n *\r\n * The following properties are expected:\r\n *  - The root must be a valid node. That is, a node that passes AST.isNode()\r\n *  - Every non-leaf node (!AST.isLeaf()) must conatin in it's 'value' field a possibly empty array of nodes.\r\n *  - Such array must not contain anything other than nodes, in particular it can not conatain other arrays.\r\n *  - The 'value' field of a leaf may be of any type as long as is not a type of object (including arrays).\r\n *  - Extra fields are allowed.\r\n */\r\nclass AST {\r\n  constructor (rawTree, isValid = undefined) {\r\n    this.tree = isValid ? rawTree : AST.validate(rawTree)\r\n  }\r\n\r\n  get value () {\r\n    if (Array.isArray(this.tree.value)) {\r\n      return this.tree.value.map(e => new AST(e, true))\r\n    } else return this.tree.value\r\n  }\r\n\r\n  get name () { return this.tree.name }\r\n\r\n  /**\r\n   * Traverses the tree with DFS and calls enter or leave passing (Path, Token) as arguments.\r\n   * @param  {Function} enter Callback function for enetering a node. Returning true skips the children.\r\n   * @param  {Function} leave Callback function for leaving a node.\r\n   */\r\n  traverse (enter = () => {}, leave = () => {}) {\r\n    const path = []\r\n\r\n    function dfs (root) {\r\n      if (enter([...path], root)) return\r\n      if (!AST.isLeaf(root)) {\r\n        path.push(0)\r\n        for (const child of root.value) {\r\n          dfs(child)\r\n          path.push(path.pop() + 1)\r\n        }\r\n        path.pop()\r\n      }\r\n      leave([...path], root)\r\n    }\r\n\r\n    dfs(this.tree)\r\n  }\r\n\r\n  /**\r\n   * Returns an array of the leafs.\r\n   * @return {Array} Array of tokens\r\n   */\r\n  flatten () {\r\n    const arr = []\r\n    this.traverse((path, token) => {\r\n      if (AST.isLeaf(token)) arr.push(token)\r\n    })\r\n    return arr\r\n  }\r\n\r\n  /**\r\n   * Returns a list of nodes in the AST that match the given name.\r\n   * @param  {String} name Name to match.\r\n   * @return {[Object]}      Array of nodes.\r\n   */\r\n  getNodesByName (name) {\r\n    const arr = []\r\n    this.traverse((path, node) => {\r\n      if (node.name === name) arr.push(node)\r\n    })\r\n    return arr\r\n  }\r\n\r\n  /**\r\n   * Returns a list of sub-AST whose root node name attribute matches the given name.\r\n   * @param  {String} name Name to match.\r\n   * @return {[Object]}    Array of AST.\r\n   */\r\n  getSubASTsByName (name) {\r\n    return this.getNodesByName(name).map(e => new AST(e, true))\r\n  }\r\n\r\n  /**\r\n   * Returns a sub-AST of the first direct child that matches the given name.\r\n   * @param  {String} name The name attribute to match\r\n   * @return {AST}\r\n   */\r\n  getChildByName (name) {\r\n    for (const child of this.tree.value) {\r\n      if (child.name === name) return new AST(child, true)\r\n    }\r\n    throw new SyntaxError()\r\n  }\r\n\r\n  /**\r\n   * Returns the node corresponding to a given path.\r\n   * @param  {[number]} path An array of numbers, each starting from 0, corresponding to the positions at every deep level.\r\n   * @return {Object}        A valid node of the tree.\r\n   */\r\n  find (path) {\r\n    let node = this.tree\r\n    for (const i of path) {\r\n      if (typeof i !== 'number') throw new TypeError('Path contains non-numbers!')\r\n      if (AST.isLeaf(node)) throw new Error('Path is too deep ' + path)\r\n      node = node.value[i]\r\n    }\r\n    return node\r\n  }\r\n\r\n  /**\r\n   * Cuts a node of the tree by replacing it's value with an empty list.\r\n   * @param  {[number]} path   An array of numbers, each starting from 0, corresponding to the positions at every deep level.\r\n   * @return {Object}          A node like the original before being cutted (deatached from the tree).\r\n   */\r\n  cut (path) {\r\n    const node = this.find(path)\r\n    const copy = { ...node }\r\n    node.value = []\r\n    return copy\r\n  }\r\n\r\n  /**\r\n   * The offset is the index (see: AST.isIndex()) of the starting position of the root node of the tree.\r\n   */\r\n  get offset () {\r\n    return this.tree.start\r\n  }\r\n\r\n  /**\r\n   * Modifies the offset of the tree and traverses all nodes to also apply such modification.\r\n   * @param {Object} index An index object that passes AST.isIndex(index)\r\n   */\r\n  set offset (index) {\r\n    if (!AST.isIndex(index)) throw new TypeError(`Expected index object, got ${index}`)\r\n    const rootdif = {\r\n      offset: index.offset - this.offset.offset,\r\n      line: index.line - this.offset.line,\r\n      column: index.column - this.offset.column\r\n    }\r\n\r\n    this.traverse((path, node) => {\r\n      const start = {\r\n        offset: node.start.offset + rootdif.offset,\r\n        line: node.start.line + rootdif.line,\r\n        column: node.start.column + rootdif.column\r\n      }\r\n\r\n      const end = {\r\n        offset: node.end.offset + rootdif.offset,\r\n        line: node.end.line + rootdif.line,\r\n        column: node.end.column + rootdif.column\r\n      }\r\n\r\n      node.start = start\r\n      node.end = end\r\n    })\r\n\r\n    // Just in case\r\n    // AST.validate(this.tree)\r\n  }\r\n\r\n  /**\r\n   * Replaces the node of the tree at the given path with another valid node, may be used to insert a subtree.\r\n   * It also sets the offset of the inserted subtree to match the original node.\r\n   * @param  {[number]} path   An array of numbers, each starting from 0, corresponding to the positions at every deep level.\r\n   * @param  {Object} subtree  The node to be inserted.\r\n   * @return {Object}          The node that was removed.\r\n   */\r\n  replace (path, subtree) {\r\n    const prefix = path.slice()\r\n    const i = prefix.pop()\r\n    const node = this.find(prefix)\r\n    const old = node.value[i]\r\n    const ast = new AST(subtree).copy()\r\n    ast.offset = old.start\r\n    node.value[i] = ast.tree\r\n    return old\r\n  }\r\n\r\n  copy () {\r\n    this.tree = lodash.cloneDeep(this.tree)\r\n    return this\r\n  }\r\n\r\n  /**\r\n   * Retunrs a string formated with the DOT format for representing graphs.\r\n   * This can be then rendered with any compatible program, e.g. (GraphViz)\r\n   * @return {string} The DOT string representation of the tree.\r\n   */\r\n  toDot () {\r\n    function hashFromPath (path) {\r\n      if (path.length === 0) return 'root'\r\n      return path.map(e => [...e.toString()].map(c => String.fromCharCode(97 + Number(c))).join('')).join('I')\r\n    }\r\n\r\n    let ids = ''\r\n    let lines = ''\r\n    this.traverse((path, node) => {\r\n      ids += `    ${hashFromPath(path)} [label=\"${node.name}\"]\\n`\r\n      if (path.length) {\r\n        lines += '    root -> ' + [...path.keys()].map(e => path.slice(0, e + 1)).map(e => hashFromPath(e)).join(' -> ') + '\\n'\r\n      }\r\n    })\r\n    return `strict digraph graphname {\\n${ids}\\n\\n${lines}\\n}`\r\n  }\r\n\r\n  // ============================ STATIC METHODS ===============================\r\n\r\n  /**\r\n   * Validates an AST to comform correct Parsimmon format. May perform modifications.\r\n   * @param  {Tree} root Tree object\r\n   * @return {Tree}      Returns the tree object.\r\n   */\r\n  static validate (root) {\r\n    if (!AST.isNode(root)) {\r\n      if (root.status) throw new TypeError('Not a valid AST Node (with status), make sure to check the status and do not include it!')\r\n      throw new TypeError('Not a valid AST Node ' + JSON.stringify(root, null, 2))\r\n    }\r\n    if (!AST.isLeaf(root)) {\r\n      if (!Array.isArray(root.value)) {\r\n        if (typeof root.value === 'object') root.value = [root.value]\r\n        else throw new TypeError('Not a valid AST Node ' + JSON.stringify(root, null, 2))\r\n      }\r\n\r\n      for (const child of root.value) {\r\n        if (Array.isArray(child)) throw TypeError(`Not a valid AST Node (Nested array found), on Token ${root.name}. Make sure you're generating enough nodes`)\r\n        AST.validate(child)\r\n      }\r\n    }\r\n    return root\r\n  }\r\n\r\n  static isIndex (obj) {\r\n    if (typeof obj !== 'object') return false\r\n    if (typeof obj.offset !== 'number' || obj.offset < 0) return false\r\n    if (typeof obj.line !== 'number' || obj.line < 1) return false\r\n    if (typeof obj.column !== 'number' || obj.column < 1) return false\r\n    return Object.keys(obj).length === 3\r\n  }\r\n\r\n  static copyIndex (obj) {\r\n    if (!AST.isIndex(obj)) throw new TypeError()\r\n    return { offset: obj.offset, line: obj.line, column: obj.column }\r\n  }\r\n\r\n  static isNode (node) {\r\n    if (typeof node !== 'object') return false\r\n    if (node.name === undefined) return false\r\n    if (node.value === undefined) return false\r\n    if (node.start === undefined || !AST.isIndex(node.start)) return false\r\n    if (node.end === undefined || !AST.isIndex(node.end)) return false\r\n    return true\r\n  }\r\n\r\n  static isLeaf (node) {\r\n    if (!AST.isNode(node)) return false\r\n    if (typeof node.value === 'object') return false\r\n    return true\r\n  }\r\n}\r\n\r\nmodule.exports = AST\r\n","const parserUtils = require('./parser-utils')\r\n\r\n/**\r\n * From https://github.com/sindresorhus/auto-bind\r\n * Automatically bind methods to their class instance. Cutted version.\r\n * @param  {Object} self The instance, it is mutated.\r\n */\r\nfunction bind (self) {\r\n  const getAllProperties = object => {\r\n    const properties = new Set()\r\n    do {\r\n      for (const key of Reflect.ownKeys(object)) {\r\n        properties.add([object, key])\r\n      }\r\n    } while ((object = Reflect.getPrototypeOf(object)) && object !== Object.prototype)\r\n    return properties\r\n  }\r\n\r\n  for (const [object, key] of getAllProperties(self.constructor.prototype)) {\r\n    if (key === 'constructor') continue\r\n    const descriptor = Reflect.getOwnPropertyDescriptor(object, key)\r\n    if (descriptor && typeof descriptor.value === 'function') {\r\n      self[key] = self[key].bind(self)\r\n    }\r\n  }\r\n}\r\n\r\n/* eslint-disable */\r\nfunction uuidv4 () {\r\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\r\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\r\n    return v.toString(16);\r\n  });\r\n}\r\n\r\nmodule.exports = { ...parserUtils, bind, uuidv4 }\r\n"],"sourceRoot":""}